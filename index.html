<!DOCTYPE html>
<html lang="es">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Sistema para Generación de Horarios Académicos</title>

        <!-- Tailwind CSS desde jsdelivr -->
        <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">

        <style>
            body {
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                background-color: #f9fafb;
            }

            .tab-content {
                display: none;
            }

            .tab-content.active {
                display: block;
                animation: fadeIn 0.3s ease-in-out;
            }

            .session {
                background-color: #e3f2fd;
                border-radius: 0.375rem;
                padding: 0.5rem;
                margin-bottom: 0.25rem;
                cursor: move; /* Sugiere drag-and-drop, pero no implementado */
                border-left: 4px solid #2563eb;
                box-shadow: 0 2px 5px rgba(0,0,0,0.1);
                transition: transform 0.2s, box-shadow 0.2s;
            }

            .session:hover {
                transform: translateY(-2px);
                box-shadow: 0 4px 10px rgba(0,0,0,0.15);
                z-index: 2;
            }

            .conflict {
                background-color: #ffecb3;
                border-left: 4px solid #f59e0b;
            }

            .optimized {
                background-color: #c8e6c9;
                border-left: 4px solid #10b981;
            }

            .fijado {
                border-left: 4px solid #8b5cf6;
                background-color: #ddd6fe;
            }

            .timetable th, .timetable td {
                border: 1px solid #e5e7eb;
                padding: 0.5rem;
                text-align: center;
                vertical-align: top; /* Alineación vertical para celdas de horario */
            }

            .timetable th {
                background-color: #f3f4f6;
            }

            @keyframes fadeIn {
                from { opacity: 0; transform: translateY(10px); }
                to { opacity: 1; transform: translateY(0); }
            }

            .loading {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background-color: rgba(0, 0, 0, 0.7);
                z-index: 9999;
                display: none; /* Cambiado a none por defecto */
                justify-content: center;
                align-items: center;
                flex-direction: column;
            }

            .spinner {
                border: 4px solid rgba(255, 255, 255, 0.3);
                border-radius: 50%;
                border-top: 4px solid #3b82f6;
                width: 40px;
                height: 40px;
                animation: spin 1s linear infinite;
            }

            @keyframes spin {
                0% { transform: rotate(0deg); }
                100% { transform: rotate(360deg); }
            }

            .notification {
                position: fixed;
                bottom: 20px;
                right: 20px;
                padding: 1rem;
                border-radius: 0.375rem;
                box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
                z-index: 10000; /* Asegurar que esté sobre otros elementos */
                transform: translateY(100%);
                opacity: 0;
                transition: transform 0.3s ease-out, opacity 0.3s ease-out;
                min-width: 250px; /* Ancho mínimo */
                max-width: 400px; /* Ancho máximo */
            }

            .notification.show {
                transform: translateY(0);
                opacity: 1;
            }

            /* Clase para celdas editables */
            .editable-cell {
                cursor: pointer;
                position: relative;
            }

            .editable-cell:hover::after {
                content: "✏️";
                position: absolute;
                top: 2px;
                right: 2px;
                font-size: 12px;
                opacity: 0.7;
            }

            /* Estilos para la disponibilidad de profesores */
            .disponibilidad-grid {
                display: grid;
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); /* Ajustado minmax */
                gap: 1rem; /* Aumentado gap */
            }

            .dia-disponibilidad {
                border: 1px solid #e5e7eb;
                border-radius: 0.375rem;
                padding: 0.75rem; /* Aumentado padding */
                background-color: #f9fafb; /* Fondo ligero */
            }

            /* Clase auxiliar para altura máxima de modales */
            .max-h-90vh {
                max-height: 90vh;
            }

            /* Optimización para impresión PDF */
            @media print {
                body {
                    width: 100%;
                    margin: 0;
                    padding: 0;
                    -webkit-print-color-adjust: exact; /* Forzar impresión de colores de fondo en Chrome/Safari */
                    print-color-adjust: exact; /* Estándar */
                }

                .no-print {
                    display: none !important;
                }

                .tab-content {
                    display: block !important;
                    page-break-after: always;
                }

                .container {
                    max-width: 100% !important;
                    width: 100% !important;
                    padding: 10px !important;
                    margin: 0 !important;
                }

                .timetable {
                    width: 100% !important;
                    font-size: 7pt !important; /* Reducido aún más para PDF */
                    table-layout: fixed; /* Para mejor control de ancho */
                    /* Evitar que las tablas se dividan entre páginas si es posible */
                    page-break-inside: avoid;
                }
                .timetable caption {
                    font-size: 9pt !important;
                    margin-bottom: 5px !important;
                    page-break-after: avoid; /* Evitar salto justo después del título */
                }
                .timetable tbody tr {
                     page-break-inside: avoid; /* Intentar mantener filas juntas */
                }
                .timetable th, .timetable td {
                    padding: 2px !important; /* Reducido padding */
                    overflow: hidden; /* Evitar desbordamiento */
                    word-wrap: break-word; /* Romper palabras largas */
                }
                .session {
                    font-size: 6pt !important; /* Reducido tamaño de fuente en sesión */
                    padding: 2px !important;
                    margin-bottom: 1px !important;
                    border-width: 2px !important;
                    /* Forzar impresión de colores de fondo en sesiones */
                    -webkit-print-color-adjust: exact;
                    print-color-adjust: exact;
                }
                header, nav, button, input, select, .notification, .loading {
                    display: none !important; /* Ocultar elementos no necesarios */
                }
                #datosEstadisticos, #estadisticasAvanzadas, #mensajeNoHorario {
                     display: none !important; /* Ocultar estadísticas y mensajes */
                }
                #horarioContainer {
                    overflow: visible !important; /* Mostrar todo el contenido */
                }
                /* Ocultar resumen detallado en impresión */
                #resumenCargaProfesores {
                    display: none !important;
                }
            }
        </style>

        <!-- SheetJS para procesar archivos Excel -->
        <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
        <!-- jsPDF para exportación a PDF -->
        <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
        <!-- Opcional: jsPDF-AutoTable para facilitar la creación de tablas en PDF -->
        <!-- <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.5.23/dist/jspdf.plugin.autotable.min.js"></script> -->
    </head>

<body class="min-h-screen">
    <div class="loading" id="loadingScreen">
        <div class="spinner"></div>
        <div class="text-white mt-4 font-medium">Procesando datos...</div>
    </div>

    <div class="container mx-auto px-4 py-8">
        <!-- Cabecera -->
        <header class="bg-blue-600 text-white p-4 rounded-lg shadow-md mb-6 flex justify-between items-center no-print">
            <h1 class="text-2xl font-bold">Sistema para Generación de Horarios Académicos</h1>
            <div class="flex space-x-2">
                <button id="importBtn" class="bg-white text-blue-600 hover:bg-blue-100 px-4 py-2 rounded-lg shadow transition-colors font-medium">Importar Datos</button>
                <div class="relative group">
                    <button id="exportBtn" class="bg-white text-blue-600 hover:bg-blue-100 px-4 py-2 rounded-lg shadow transition-colors font-medium">Exportar Vista Actual</button>
                    <div id="exportOptionsMenu" class="absolute right-0 top-full mt-1 bg-white border border-gray-300 rounded-md shadow-lg py-2 px-3 focus:outline-none hidden group-hover:block z-10 w-60">
                        <div class="mb-2">
                            <label for="formatoExportacion" class="block text-sm font-medium text-gray-700">Formato:</label>
                            <select id="formatoExportacion" class="mt-1 block w-full py-1 px-2 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 text-sm">
                                <option value="excel">Excel (.xlsx)</option>
                                <option value="pdf">PDF (.pdf)</option>
                            </select>
                        </div>
                        <div id="pdfOptions" class="mb-2 hidden space-y-1">
                            <label for="pdfPageSize" class="block text-sm font-medium text-gray-700">Tamaño PDF:</label>
                            <select id="pdfPageSize" class="mt-1 block w-full py-1 px-2 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 text-sm"><option value="letter">Carta</option><option value="legal">Oficio</option><option value="a4">A4</option></select>
                            <label for="pdfOrientation" class="block text-sm font-medium text-gray-700">Orientación PDF:</label>
                            <select id="pdfOrientation" class="mt-1 block w-full py-1 px-2 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 text-sm"><option value="landscape">Horizontal</option><option value="portrait">Vertical</option></select>
                        </div>
                        <button id="doExportBtn" class="w-full bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded transition-colors text-sm">Exportar</button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Navegación por pestañas -->
        <nav class="bg-gray-800 rounded-lg shadow-md mb-6 overflow-x-auto no-print">
            <ul class="flex flex-wrap">
                <li><a href="#configuracion" class="tab-link active px-4 py-3 text-white hover:bg-blue-600 inline-block transition-colors">Configuración</a></li>
                <li><a href="#profesores" class="tab-link px-4 py-3 text-white hover:bg-blue-600 inline-block transition-colors">Profesores</a></li>
                <li><a href="#materias" class="tab-link px-4 py-3 text-white hover:bg-blue-600 inline-block transition-colors">Materias</a></li>
                <li><a href="#aulas" class="tab-link px-4 py-3 text-white hover:bg-blue-600 inline-block transition-colors">Aulas</a></li>
                <li><a href="#restricciones" class="tab-link px-4 py-3 text-white hover:bg-blue-600 inline-block transition-colors">Restricciones</a></li>
                <li><a href="#horarios" class="tab-link px-4 py-3 text-white hover:bg-blue-600 inline-block transition-colors">Horarios</a></li>
            </ul>
        </nav>

        <!-- Pestaña de Configuración -->
        <div id="configuracion" class="tab-content active">
            <div class="bg-white p-6 rounded-lg shadow-md mb-6">
                <div class="flex justify-between items-center mb-4 border-b pb-3">
                    <h2 class="text-xl font-semibold text-gray-800">Configuración General</h2>
                    <button id="saveConfigBtn" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded transition-colors no-print">Guardar Configuración</button>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <div>
                        <label for="periodoAcademico" class="block text-gray-700 font-medium mb-2">Periodo Académico:</label>
                        <select id="periodoAcademico" class="w-full px-4 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="semestral">Semestral</option>
                            <option value="anual">Anual</option>
                        </select>
                    </div>
                    <div>
                        <label for="cantidadSemestres" class="block text-gray-700 font-medium mb-2">Cantidad de Semestres/Niveles:</label>
                        <select id="cantidadSemestres" class="w-full px-4 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="3">3</option>
                            <option value="4">4</option>
                            <option value="5">5</option>
                            <option value="6">6</option>
                            <option value="7">7</option>
                            <option value="8">8</option>
                            <option value="9">9</option>
                            <option value="10">10</option>
                            <option value="11">11</option>
                            <option value="12">12</option>
                        </select>
                    </div>
                    <div>
                        <label for="horaInicio" class="block text-gray-700 font-medium mb-2">Hora de Inicio de Jornada:</label>
                        <input type="time" id="horaInicio" value="07:00" class="w-full px-4 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label for="horaFin" class="block text-gray-700 font-medium mb-2">Hora de Fin de Jornada:</label>
                        <input type="time" id="horaFin" value="18:00" class="w-full px-4 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label for="duracionBloque" class="block text-gray-700 font-medium mb-2">Duración de Bloque (minutos):</label>
                        <input type="number" id="duracionBloque" min="30" max="120" step="15" value="60" class="w-full px-4 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                </div>

                <div class="mt-4">
                    <label class="block text-gray-700 font-medium mb-2">Días de la Semana:</label>
                    <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-2">
                        <div class="flex items-center p-2 rounded-md hover:bg-gray-100">
                            <input type="checkbox" id="diaLunes" data-dia="Lunes" class="mr-2 dia-semana-check">
                            <label for="diaLunes">Lunes</label>
                        </div>
                        <div class="flex items-center p-2 rounded-md hover:bg-gray-100">
                            <input type="checkbox" id="diaMartes" data-dia="Martes" class="mr-2 dia-semana-check">
                            <label for="diaMartes">Martes</label>
                        </div>
                        <div class="flex items-center p-2 rounded-md hover:bg-gray-100">
                            <input type="checkbox" id="diaMiercoles" data-dia="Miércoles" class="mr-2 dia-semana-check">
                            <label for="diaMiercoles">Miércoles</label>
                        </div>
                        <div class="flex items-center p-2 rounded-md hover:bg-gray-100">
                            <input type="checkbox" id="diaJueves" data-dia="Jueves" class="mr-2 dia-semana-check">
                            <label for="diaJueves">Jueves</label>
                        </div>
                        <div class="flex items-center p-2 rounded-md hover:bg-gray-100">
                            <input type="checkbox" id="diaViernes" data-dia="Viernes" class="mr-2 dia-semana-check">
                            <label for="diaViernes">Viernes</label>
                        </div>
                        <div class="flex items-center p-2 rounded-md hover:bg-gray-100">
                            <input type="checkbox" id="diaSabado" data-dia="Sábado" class="mr-2 dia-semana-check">
                            <label for="diaSabado">Sábado</label>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Nueva sección de Configuración de Asesorías -->
            <div class="bg-white p-6 rounded-lg shadow-md mb-6">
                <div class="border-b pb-3 mb-4">
                    <h2 class="text-xl font-semibold text-gray-800">Configuración de Asesorías</h2>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Asesorías Normales -->
                    <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
                        <h3 class="font-medium text-gray-700 mb-3">Asesorías Académicas Normales</h3>
                        <div class="flex items-center mb-3">
                            <input type="checkbox" id="habilitarAsesoriasNormales" class="mr-2 h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                            <label for="habilitarAsesoriasNormales" class="text-sm font-medium text-gray-700">Habilitar Asesorías Normales</label>
                        </div>
                        <div class="space-y-2">
                            <div>
                                <label for="duracionAsesoriaNormal" class="block text-sm font-medium text-gray-600">Duración por sesión (minutos):</label>
                                <input type="number" id="duracionAsesoriaNormal" min="15" max="240" step="15" value="60" class="mt-1 w-full px-3 py-1 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 text-sm">
                            </div>
                            <div>
                                <label for="frecuenciaAsesoriaNormal" class="block text-sm font-medium text-gray-600">Veces por semana:</label>
                                <input type="number" id="frecuenciaAsesoriaNormal" min="1" max="5" step="1" value="1" class="mt-1 w-full px-3 py-1 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 text-sm">
                            </div>
                        </div>
                    </div>
                    <!-- Asesorías Evaluación Diferencial -->
                    <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
                        <h3 class="font-medium text-gray-700 mb-3">Asesorías Evaluación Diferencial (Obligatorias)</h3>
                        <div class="flex items-center mb-3">
                            <input type="checkbox" id="habilitarAsesoriasEvaluacion" class="mr-2 h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                            <label for="habilitarAsesoriasEvaluacion" class="text-sm font-medium text-gray-700">Habilitar Asesorías de Evaluación</label>
                        </div>
                        <div class="space-y-2">
                            <div>
                                <label for="duracionAsesoriaEvaluacion" class="block text-sm font-medium text-gray-600">Duración por sesión (minutos):</label>
                                <input type="number" id="duracionAsesoriaEvaluacion" min="30" max="240" step="30" value="120" class="mt-1 w-full px-3 py-1 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 text-sm">
                            </div>
                            <div>
                                <label for="frecuenciaAsesoriaEvaluacion" class="block text-sm font-medium text-gray-600">Veces por semana:</label>
                                <input type="number" id="frecuenciaAsesoriaEvaluacion" min="1" max="5" step="1" value="1" class="mt-1 w-full px-3 py-1 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 text-sm">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Fin Nueva sección de Configuración de Asesorías -->


            <div class="bg-white p-6 rounded-lg shadow-md mb-6">
                <div class="border-b pb-3 mb-4">
                    <h2 class="text-xl font-semibold text-gray-800">Opciones de Optimización</h2>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="prioridadOptimizacion" class="block text-gray-700 font-medium mb-2">Prioridad de Optimización:</label>
                        <select id="prioridadOptimizacion" class="w-full px-4 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="estudiantes">Priorizar Estudiantes (Evitar Huecos)</option>
                            <option value="profesores">Priorizar Profesores (Respetar Preferencias)</option>
                            <option value="aulas">Priorizar Aulas (Optimizar Uso)</option>
                            <option value="equilibrado">Equilibrado</option>
                        </select>
                    </div>
                    <div>
                        <label for="maxIteraciones" class="block text-gray-700 font-medium mb-2">Máximo de Iteraciones:</label>
                        <input type="number" id="maxIteraciones" min="100" max="10000" step="100" value="1000" class="w-full px-4 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label for="tiempoMaximo" class="block text-gray-700 font-medium mb-2">Tiempo Máximo (segundos):</label>
                        <input type="number" id="tiempoMaximo" min="10" max="300" step="5" value="60" class="w-full px-4 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <!-- Sección de asesorías anterior eliminada -->
                </div>
            </div>

            <div class="bg-white p-6 rounded-lg shadow-md mb-6 no-print">
                <h2 class="text-xl font-semibold text-gray-800 mb-4">Datos Excel</h2>
                <div class="mb-4">
                    <p class="text-gray-700 mb-3">Carga el archivo Excel con los datos para la generación de horarios (Profesores, Materias, Aulas, Restricciones Fijas - opcional):</p>
                    <input type="file" id="excelFileInput" accept=".xlsx, .xls" class="block w-full text-sm text-gray-500
                        file:mr-4 file:py-2 file:px-4
                        file:rounded-md file:border-0
                        file:text-sm file:font-medium
                        file:bg-blue-50 file:text-blue-700
                        hover:file:bg-blue-100">
                    <p class="text-sm text-gray-500 mt-1">Archivos permitidos: .xlsx, .xls</p>
                </div>
                <div class="mt-4">
                    <button id="cargarDatosExcel" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded transition-colors">Cargar Datos desde Excel</button>
                    <button id="cargarDatosEjemplo" class="ml-2 bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded transition-colors">Cargar Datos de Ejemplo</button>
                </div>
            </div>
        </div>

        <!-- Pestaña de Profesores -->
        <div id="profesores" class="tab-content">
            <div class="bg-white p-6 rounded-lg shadow-md mb-6">
                <div class="flex justify-between items-center mb-4 border-b pb-3">
                    <h2 class="text-xl font-semibold text-gray-800">Gestión de Profesores</h2>
                    <button id="addProfesorBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded transition-colors no-print">Añadir Profesor</button>
                </div>
                <div class="bg-blue-50 border-l-4 border-blue-500 text-blue-700 p-4 mb-4 no-print">
                    <p>Registre los profesores, las materias que pueden dictar, su disponibilidad y otras cargas laborales. Puede editar los datos haciendo clic en las celdas.</p>
                </div>
                <div class="mb-4 no-print">
                    <input type="text" id="buscarProfesor" placeholder="Buscar profesor por nombre..." class="w-full px-4 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div class="overflow-x-auto">
                    <table id="tablaProfesores" class="min-w-full bg-white">
                        <thead>
                            <tr class="bg-gray-100 text-gray-600 uppercase text-sm leading-normal">
                                <th class="py-3 px-6 text-left">Código</th>
                                <th class="py-3 px-6 text-left">Nombre</th>
                                <th class="py-3 px-6 text-left">Especialidad</th>
                                <th class="py-3 px-6 text-left">Materias/Carga Total (h)</th> <!-- Modificado -->
                                <th class="py-3 px-6 text-center no-print">Acciones</th>
                            </tr>
                        </thead>
                        <tbody class="text-gray-600 text-sm font-light">
                            <!-- Contenido generado por JS -->
                            <tr>
                                <td colspan="5" class="py-4 px-6 text-center">No hay datos. Cargue datos desde Excel o añada profesores manualmente.</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <!-- Resumen Detallado Carga Laboral -->
                <div id="resumenCargaProfesores" class="mt-6 no-print">
                    <h3 class="text-lg font-semibold text-gray-700 mb-2 border-t pt-4">Resumen Detallado de Carga Laboral (Horas Semanales Estimadas)</h3>
                    <div class="overflow-x-auto">
                        <table class="min-w-full bg-gray-50 text-sm">
                            <thead>
                                <tr class="bg-gray-200 text-gray-600 uppercase text-xs leading-normal">
                                    <th class="py-2 px-3 text-left">Profesor</th>
                                    <th class="py-2 px-3 text-center" title="Horas de clase asignadas según horario y duración de bloque">Clases</th>
                                    <th class="py-2 px-3 text-center" title="Horas según configuración de Asesorías Normales">Ases. Normal</th>
                                    <th class="py-2 px-3 text-center" title="Horas según configuración de Asesorías de Evaluación Diferencial">Ases. Eval.</th>
                                    <th class="py-2 px-3 text-center">Investigación</th>
                                    <th class="py-2 px-3 text-center">Proy. Inst.</th>
                                    <th class="py-2 px-3 text-center">Proy. Ext.</th>
                                    <th class="py-2 px-3 text-center">Mat. Didáct.</th>
                                    <th class="py-2 px-3 text-center" title="Horas de capacitación semestral prorrateadas semanalmente (asumiendo 16 semanas/semestre)">Capacitación</th>
                                    <th class="py-2 px-3 text-center font-bold">Total Semanal</th>
                                    <!-- Opcional: <th class="py-2 px-3 text-center">Objetivo</th> -->
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Filas generadas por JS -->
                                <tr><td colspan="10" class="py-3 px-4 text-center text-gray-500">Calculando carga...</td></tr>
                            </tbody>
                        </table>
                        <p class="text-xs text-gray-500 mt-1">* Las horas de capacitación se prorratean asumiendo un semestre de 16 semanas.</p>
                        <p class="text-xs text-gray-500 mt-1">* Las horas de clase se calculan multiplicando los bloques asignados por la duración global del bloque (configuración).</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Pestaña de Materias -->
        <div id="materias" class="tab-content">
            <div class="bg-white p-6 rounded-lg shadow-md mb-6">
                <div class="flex justify-between items-center mb-4 border-b pb-3">
                    <h2 class="text-xl font-semibold text-gray-800">Gestión de Materias</h2>
                    <button id="addMateriaBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded transition-colors no-print">Añadir Materia</button>
                </div>
                <div class="bg-blue-50 border-l-4 border-blue-500 text-blue-700 p-4 mb-4 no-print">
                    <p>Registre las materias, indicando el semestre, bloques semanales y tipo de aula. Puede editar los datos haciendo clic en las celdas.</p>
                </div>
                <div class="mb-4 no-print">
                    <input type="text" id="buscarMateria" placeholder="Buscar materia por nombre..." class="w-full px-4 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div class="overflow-x-auto">
                    <table id="tablaMaterias" class="min-w-full bg-white">
                        <thead>
                            <tr class="bg-gray-100 text-gray-600 uppercase text-sm leading-normal">
                                <th class="py-3 px-6 text-left">Código</th>
                                <th class="py-3 px-6 text-left">Nombre</th>
                                <th class="py-3 px-6 text-left">Semestre</th>
                                <th class="py-3 px-6 text-left">Bloques Sem.</th>
                                <th class="py-3 px-6 text-left">Tipo Aula</th>
                                <th class="py-3 px-6 text-center no-print">Acciones</th>
                            </tr>
                        </thead>
                        <tbody class="text-gray-600 text-sm font-light">
                            <!-- Contenido generado por JS -->
                            <tr>
                                <td colspan="6" class="py-4 px-6 text-center">No hay datos. Cargue datos desde Excel o añada materias manualmente.</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Pestaña de Aulas -->
        <div id="aulas" class="tab-content">
            <div class="bg-white p-6 rounded-lg shadow-md mb-6">
                <div class="flex justify-between items-center mb-4 border-b pb-3">
                    <h2 class="text-xl font-semibold text-gray-800">Gestión de Aulas</h2>
                    <button id="addAulaBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded transition-colors no-print">Añadir Aula</button>
                </div>
                <div class="bg-blue-50 border-l-4 border-blue-500 text-blue-700 p-4 mb-4 no-print">
                    <p>Registre las aulas disponibles, su capacidad y características. Puede editar los datos haciendo clic en las celdas.</p>
                </div>
                <div class="mb-4 grid grid-cols-1 md:grid-cols-2 gap-4 no-print">
                    <div>
                        <input type="text" id="buscarAula" placeholder="Buscar aula por nombre..." class="w-full px-4 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <select id="filtroTipoAula" class="w-full px-4 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="todos">Todos los tipos</option>
                            <option value="normal">Normal</option>
                            <option value="laboratorio">Laboratorio</option>
                            <option value="informatica">Informática</option>
                            <option value="auditorio">Auditorio</option>
                        </select>
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table id="tablaAulas" class="min-w-full bg-white">
                        <thead>
                            <tr class="bg-gray-100 text-gray-600 uppercase text-sm leading-normal">
                                <th class="py-3 px-6 text-left">Código</th>
                                <th class="py-3 px-6 text-left">Nombre</th>
                                <th class="py-3 px-6 text-left">Tipo</th>
                                <th class="py-3 px-6 text-left">Capacidad</th>
                                <th class="py-3 px-6 text-left">Ubicación</th>
                                <th class="py-3 px-6 text-center no-print">Acciones</th>
                            </tr>
                        </thead>
                        <tbody class="text-gray-600 text-sm font-light">
                            <!-- Contenido generado por JS -->
                            <tr>
                                <td colspan="6" class="py-4 px-6 text-center">No hay datos. Cargue datos desde Excel o añada aulas manualmente.</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Pestaña de Restricciones -->
        <div id="restricciones" class="tab-content">
            <div class="bg-white p-6 rounded-lg shadow-md mb-6">
                <div class="flex justify-between items-center mb-4 border-b pb-3">
                    <h2 class="text-xl font-semibold text-gray-800">Restricciones y Preferencias</h2>
                    <button id="guardarRestricciones" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded transition-colors no-print">Guardar Restricciones</button>
                </div>
                <div class="bg-blue-50 border-l-4 border-blue-500 text-blue-700 p-4 mb-6 no-print">
                    <p>Configure las restricciones para la generación de horarios. Las restricciones marcadas como "Estricta" deben cumplirse obligatoriamente, mientras que las "Ponderables" se intentarán satisfacer según su peso.</p>
                </div>

                <h3 class="text-lg font-semibold text-gray-700 mb-2">Restricciones Globales (Ponderables)</h3>
                <div class="bg-gray-50 p-4 rounded-lg mb-6">
                    <div class="border-b border-gray-200 pb-4 mb-4">
                        <div class="flex flex-wrap justify-between items-start">
                            <div class="w-full md:w-2/3 mb-3 md:mb-0">
                                <div class="font-medium">Evitar huecos en horarios de estudiantes</div>
                                <p class="text-sm text-gray-600">Minimizar horas libres entre clases para los estudiantes.</p>
                            </div>
                            <div class="w-full md:w-1/3 flex items-center md:justify-end space-x-2">
                                <label for="evitarHuecosPeso" class="text-sm">Peso (1-10):</label>
                                <input type="number" id="evitarHuecosPeso" min="1" max="10" value="8" class="w-16 px-2 py-1 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <input type="hidden" id="evitarHuecosTipo" value="ponderable"> <!-- Simplificado a ponderable -->
                            </div>
                        </div>
                    </div>

                     <div class="border-b border-gray-200 pb-4 mb-4">
                        <div class="flex flex-wrap justify-between items-start">
                            <div class="w-full md:w-2/3 mb-3 md:mb-0">
                                <div class="font-medium">Máximo de horas consecutivas (Profesor)</div>
                                <p class="text-sm text-gray-600">Limitar el número de horas de clase seguidas para un profesor.</p>
                            </div>
                            <div class="w-full md:w-1/3 flex items-center md:justify-end space-x-2">
                                <label for="maxHorasConsecutivasValor" class="text-sm">Máx. Horas:</label>
                                <input type="number" id="maxHorasConsecutivasValor" min="2" max="6" value="4" class="w-16 px-2 py-1 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <label for="maxHorasConsecutivasPeso" class="text-sm ml-2">Peso (1-10):</label>
                                <input type="number" id="maxHorasConsecutivasPeso" min="1" max="10" value="7" class="w-16 px-2 py-1 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <input type="hidden" id="maxHorasConsecutivasTipo" value="ponderable"> <!-- Simplificado a ponderable -->
                            </div>
                        </div>
                    </div>
                    <!-- Restricciones Estrictas (implícitas o manejadas en la lógica) -->
                     <p class="text-sm text-gray-600 mt-4">Nota: La disponibilidad de profesores, la asignación profesor-materia y el tipo de aula requerido se consideran restricciones estrictas durante la generación inicial.</p>
                     <input type="hidden" id="respetarDisponibilidadTipo" value="estricta">
                     <input type="hidden" id="respetarDisponibilidadPeso" value="10">
                     <input type="hidden" id="respetarTipoAulaTipo" value="estricta">
                     <input type="hidden" id="respetarTipoAulaPeso" value="10">
                </div>


                <h3 class="text-lg font-semibold text-gray-700 mb-2">Fijar Horarios Específicos (Restricción Estricta)</h3>
                <div class="bg-gray-50 p-4 rounded-lg mb-6">
                    <p class="text-sm text-gray-600 mb-3">Asigne manualmente una materia a un profesor (que pueda dictarla), aula, día y hora específicos. Esta asignación no se cambiará.</p>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-4">
                        <div>
                            <label for="profesorRestriccion" class="block text-gray-700 font-medium mb-2">Profesor:</label>
                            <select id="profesorRestriccion" class="w-full px-4 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                                <option value="">Seleccione un profesor</option>
                            </select>
                        </div>
                        <div>
                            <label for="materiaRestriccion" class="block text-gray-700 font-medium mb-2">Materia:</label>
                            <select id="materiaRestriccion" class="w-full px-4 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                                <option value="">Seleccione materia</option>
                            </select>
                        </div>
                        <div>
                            <label for="aulaRestriccion" class="block text-gray-700 font-medium mb-2">Aula:</label>
                            <select id="aulaRestriccion" class="w-full px-4 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                                <option value="">Seleccione aula</option>
                            </select>
                        </div>
                        <div>
                            <label for="diaRestriccion" class="block text-gray-700 font-medium mb-2">Día:</label>
                            <select id="diaRestriccion" class="w-full px-4 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                                <option value="">Seleccione día</option>
                            </select>
                        </div>
                        <div>
                            <label for="horaRestriccion" class="block text-gray-700 font-medium mb-2">Hora:</label>
                            <select id="horaRestriccion" class="w-full px-4 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                                <option value="">Seleccione hora</option>
                            </select>
                        </div>
                    </div>
                    <button id="fijarHorarioBtn" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded transition-colors no-print">Fijar Horario</button>
                    <div id="listaHorariosFijos" class="mt-4">
                        <h4 class="font-medium mb-2">Horarios Fijos Actuales:</h4>
                        <ul class="list-disc list-inside text-sm text-gray-700">
                            <!-- Se llenará dinámicamente -->
                            <li>No hay horarios fijos definidos.</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>


        <!-- Pestaña de Horarios -->
        <div id="horarios" class="tab-content">
            <div class="bg-white p-6 rounded-lg shadow-md mb-6">
                <div class="flex flex-wrap justify-between items-center mb-4 border-b pb-3">
                    <h2 class="text-xl font-semibold text-gray-800">Generación y Visualización de Horarios</h2>
                    <div class="flex space-x-2 mt-2 md:mt-0 no-print">
                        <button id="generarHorariosBtn" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded transition-colors" disabled>Generar Horarios</button>
                        <button id="optimizarHorariosBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded transition-colors ml-2" disabled>Optimizar</button>
                        <button id="modoEdicionBtn" class="bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-2 rounded transition-colors ml-2" disabled>Editar Manualmente</button>
                    </div>
                </div>
                <div class="bg-blue-50 border-l-4 border-blue-500 text-blue-700 p-4 mb-4 no-print">
                    <p>Genere y visualice los horarios. Puede optimizarlos o editarlos manualmente (doble clic en una sesión para editar).</p>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-4 no-print">
                    <div>
                        <label for="filtroVistaHorario" class="block text-gray-700 font-medium mb-2">Ver horario de:</label>
                        <select id="filtroVistaHorario" class="w-full px-4 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="semestre">Por Semestre</option>
                            <option value="profesor">Por Profesor</option>
                            <option value="aula">Por Aula</option>
                            <option value="materia">Por Materia</option>
                            <option value="asesoria">Por Asesoría (Profesor)</option>
                        </select>
                    </div>

                    <div id="selectorElemento">
                        <label for="elementoSeleccionado" class="block text-gray-700 font-medium mb-2">Seleccione semestre:</label>
                        <select id="elementoSeleccionado" class="w-full px-4 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="1">Semestre 1</option>
                            <!-- Opciones generadas por JS -->
                        </select>
                    </div>
                </div>

                <div id="datosEstadisticos" class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6 no-print">
                    <div class="bg-white border rounded-lg p-4 shadow-sm">
                        <h4 class="font-medium text-gray-600 mb-1">Horas Asignadas</h4>
                        <p id="horasAsignadas" class="text-xl font-bold text-blue-600">0/0 (0%)</p>
                    </div>
                    <div class="bg-white border rounded-lg p-4 shadow-sm">
                        <h4 class="font-medium text-gray-600 mb-1">Aulas Utilizadas</h4>
                        <p id="aulasUtilizadas" class="text-xl font-bold text-green-600">0/0 (0%)</p>
                    </div>
                    <div class="bg-white border rounded-lg p-4 shadow-sm">
                        <h4 class="font-medium text-gray-600 mb-1">Conflictos Detectados</h4>
                        <p id="conflictosDetectados" class="text-xl font-bold text-orange-600">0</p>
                    </div>
                </div>

                <!-- Contenedor para estadísticas avanzadas (opcional) -->
                <div id="estadisticasAvanzadas" class="mb-6 no-print"></div>

                <div id="horarioContainer" class="overflow-x-auto">
                    <div id="mensajeNoHorario" class="py-12 text-center">
                        <div class="text-4xl text-gray-300 mb-4">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-20 w-20 mx-auto" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                            </svg>
                        </div>
                        <h3 class="text-xl font-medium text-gray-500">No hay horarios generados</h3>
                        <p class="text-gray-500 mt-2 mb-4">Cargue datos y haga clic en "Generar Horarios" para comenzar</p>
                        <button id="generarHorariosBtnAlt" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded transition-colors no-print" disabled>Generar Horarios</button>
                    </div>
                    <table id="tablaHorario" class="timetable w-full border-collapse hidden">
                        <!-- El horario se generará dinámicamente -->
                    </table>
                    <!-- Contenedor para horario de asesorías -->
                    <table id="tablaHorarioAsesorias" class="timetable w-full border-collapse hidden mt-8">
                         <!-- El horario de asesorías se generará dinámicamente -->
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Notificación Flotante -->
    <div id="notification" class="notification bg-white text-gray-800 hidden">
        <div class="flex justify-between items-center mb-1">
             <div class="font-bold" id="notificationTitle">Título</div>
             <button onclick="this.parentElement.parentElement.classList.remove('show'); setTimeout(() => this.parentElement.parentElement.classList.add('hidden'), 300);" class="text-gray-500 hover:text-gray-700">&times;</button>
        </div>
        <div id="notificationMessage">Mensaje</div>
    </div>

    <!-- Modales -->
    <div id="modalProfesor" class="fixed inset-0 bg-black bg-opacity-50 items-center justify-center hidden z-50 no-print">
        <div class="bg-white p-6 rounded-lg shadow-lg w-11/12 md:w-2/3 lg:w-1/2 max-h-90vh overflow-y-auto">
            <h2 class="text-xl font-bold mb-4" id="modalProfesorTitulo">Datos del Profesor</h2>
            <input type="hidden" id="profesorEditId"> <!-- Campo oculto para ID en edición -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <div>
                    <label for="profesorCodigo" class="block text-gray-700 font-medium mb-2">Código:</label>
                    <input type="text" id="profesorCodigo" class="w-full px-4 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                </div>
                <div>
                    <label for="profesorNombre" class="block text-gray-700 font-medium mb-2">Nombre:</label>
                    <input type="text" id="profesorNombre" class="w-full px-4 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                </div>
                <div class="md:col-span-2">
                    <label for="profesorEspecialidad" class="block text-gray-700 font-medium mb-2">Especialidad:</label>
                    <input type="text" id="profesorEspecialidad" class="w-full px-4 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
            </div>

            <!-- Nuevos campos de carga laboral -->
            <div class="border-t pt-4 mt-4 mb-4">
                <h3 class="text-lg font-semibold text-gray-700 mb-3">Carga Laboral Adicional (Horas Semanales)</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <div>
                        <label for="profesorInvestigacion" class="block text-sm font-medium text-gray-600">Investigación:</label>
                        <input type="number" id="profesorInvestigacion" min="0" step="0.5" value="0" class="mt-1 w-full px-3 py-1 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 text-sm">
                    </div>
                    <div>
                        <label for="profesorProyectosInst" class="block text-sm font-medium text-gray-600">Proy. Institucionales:</label>
                        <input type="number" id="profesorProyectosInst" min="0" step="0.5" value="0" class="mt-1 w-full px-3 py-1 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 text-sm">
                    </div>
                    <div>
                        <label for="profesorProyectosExt" class="block text-sm font-medium text-gray-600">Proy. Externos:</label>
                        <input type="number" id="profesorProyectosExt" min="0" step="0.5" value="0" class="mt-1 w-full px-3 py-1 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 text-sm">
                    </div>
                    <div>
                        <label for="profesorMaterial" class="block text-sm font-medium text-gray-600">Material Didáctico:</label>
                        <input type="number" id="profesorMaterial" min="0" step="0.5" value="0" class="mt-1 w-full px-3 py-1 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 text-sm">
                    </div>
                    <div>
                        <label for="profesorCapacitacion" class="block text-sm font-medium text-gray-600" title="Total de horas de capacitación durante el semestre. Se prorratearán semanalmente en el resumen.">Capacitación (Semestral):</label>
                        <input type="number" id="profesorCapacitacion" min="0" step="1" value="0" class="mt-1 w-full px-3 py-1 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 text-sm">
                    </div>
                    <!-- Opcional: Horas Objetivo -->
                    <!--
                    <div>
                        <label for="profesorHorasObjetivo" class="block text-sm font-medium text-gray-600">Horas Objetivo Semanal:</label>
                        <input type="number" id="profesorHorasObjetivo" min="0" step="1" placeholder="Opcional" class="mt-1 w-full px-3 py-1 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 text-sm">
                    </div>
                     -->
                </div>
            </div>
            <!-- Fin nuevos campos -->


            <div class="mb-4 border-t pt-4 mt-4">
                <label class="block text-gray-700 font-medium mb-2">Materias que puede dictar:</label>
                <div id="profesorMateriasContainer" class="max-h-40 overflow-y-auto border rounded p-2 grid grid-cols-2 md:grid-cols-3 gap-2">
                    <!-- Checkboxes de materias generados por JS -->
                </div>
            </div>
            <div class="mb-4">
                <label class="block text-gray-700 font-medium mb-2">Disponibilidad Semanal:</label>
                <div class="disponibilidad-grid">
                    <!-- Lunes -->
                    <div class="dia-disponibilidad">
                        <h4 class="font-medium mb-1">Lunes</h4>
                        <div class="grid grid-cols-2 gap-1">
                            <div class="flex items-center">
                                <input type="checkbox" id="dispLunesMañana" data-dia="Lunes" data-turno="mañana" class="mr-1 disp-check">
                                <label for="dispLunesMañana" class="text-sm">Mañana</label>
                            </div>
                            <div class="flex items-center">
                                <input type="checkbox" id="dispLunesTarde" data-dia="Lunes" data-turno="tarde" class="mr-1 disp-check">
                                <label for="dispLunesTarde" class="text-sm">Tarde</label>
                            </div>
                        </div>
                    </div>
                    <!-- Martes -->
                    <div class="dia-disponibilidad">
                        <h4 class="font-medium mb-1">Martes</h4>
                        <div class="grid grid-cols-2 gap-1">
                            <div class="flex items-center">
                                <input type="checkbox" id="dispMartesMañana" data-dia="Martes" data-turno="mañana" class="mr-1 disp-check">
                                <label for="dispMartesMañana" class="text-sm">Mañana</label>
                            </div>
                            <div class="flex items-center">
                                <input type="checkbox" id="dispMartesTarde" data-dia="Martes" data-turno="tarde" class="mr-1 disp-check">
                                <label for="dispMartesTarde" class="text-sm">Tarde</label>
                            </div>
                        </div>
                    </div>
                    <!-- Miércoles -->
                     <div class="dia-disponibilidad">
                        <h4 class="font-medium mb-1">Miércoles</h4>
                        <div class="grid grid-cols-2 gap-1">
                            <div class="flex items-center">
                                <input type="checkbox" id="dispMiercolesMañana" data-dia="Miércoles" data-turno="mañana" class="mr-1 disp-check">
                                <label for="dispMiercolesMañana" class="text-sm">Mañana</label>
                            </div>
                            <div class="flex items-center">
                                <input type="checkbox" id="dispMiercolesTarde" data-dia="Miércoles" data-turno="tarde" class="mr-1 disp-check">
                                <label for="dispMiercolesTarde" class="text-sm">Tarde</label>
                            </div>
                        </div>
                    </div>
                    <!-- Jueves -->
                     <div class="dia-disponibilidad">
                        <h4 class="font-medium mb-1">Jueves</h4>
                        <div class="grid grid-cols-2 gap-1">
                            <div class="flex items-center">
                                <input type="checkbox" id="dispJuevesMañana" data-dia="Jueves" data-turno="mañana" class="mr-1 disp-check">
                                <label for="dispJuevesMañana" class="text-sm">Mañana</label>
                            </div>
                            <div class="flex items-center">
                                <input type="checkbox" id="dispJuevesTarde" data-dia="Jueves" data-turno="tarde" class="mr-1 disp-check">
                                <label for="dispJuevesTarde" class="text-sm">Tarde</label>
                            </div>
                        </div>
                    </div>
                    <!-- Viernes -->
                     <div class="dia-disponibilidad">
                        <h4 class="font-medium mb-1">Viernes</h4>
                        <div class="grid grid-cols-2 gap-1">
                            <div class="flex items-center">
                                <input type="checkbox" id="dispViernesMañana" data-dia="Viernes" data-turno="mañana" class="mr-1 disp-check">
                                <label for="dispViernesMañana" class="text-sm">Mañana</label>
                            </div>
                            <div class="flex items-center">
                                <input type="checkbox" id="dispViernesTarde" data-dia="Viernes" data-turno="tarde" class="mr-1 disp-check">
                                <label for="dispViernesTarde" class="text-sm">Tarde</label>
                            </div>
                        </div>
                    </div>
                    <!-- Sábado -->
                     <div class="dia-disponibilidad">
                        <h4 class="font-medium mb-1">Sábado</h4>
                        <div class="grid grid-cols-2 gap-1">
                            <div class="flex items-center">
                                <input type="checkbox" id="dispSabadoMañana" data-dia="Sábado" data-turno="mañana" class="mr-1 disp-check">
                                <label for="dispSabadoMañana" class="text-sm">Mañana</label>
                            </div>
                            <div class="flex items-center">
                                <input type="checkbox" id="dispSabadoTarde" data-dia="Sábado" data-turno="tarde" class="mr-1 disp-check">
                                <label for="dispSabadoTarde" class="text-sm">Tarde</label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="mt-6 flex justify-end">
                <button id="cancelarProfesorBtn" type="button" class="px-4 py-2 bg-gray-300 text-gray-700 rounded-md mr-2">Cancelar</button>
                <button id="guardarProfesorBtn" type="button" class="px-4 py-2 bg-blue-600 text-white rounded-md">Guardar</button>
            </div>
        </div>
    </div>

    <!-- Modal para Materias -->
    <div id="modalMateria" class="fixed inset-0 bg-black bg-opacity-50 items-center justify-center hidden z-50 no-print">
        <div class="bg-white p-6 rounded-lg shadow-lg w-11/12 md:w-2/3 lg:w-1/2 max-h-90vh overflow-y-auto">
            <h2 class="text-xl font-bold mb-4" id="modalMateriaTitulo">Datos de la Materia</h2>
             <input type="hidden" id="materiaEditId">
            <div class="mb-4">
                <label for="materiaCodigo" class="block text-gray-700 font-medium mb-2">Código:</label>
                <input type="text" id="materiaCodigo" class="w-full px-4 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
            </div>
            <div class="mb-4">
                <label for="materiaNombre" class="block text-gray-700 font-medium mb-2">Nombre:</label>
                <input type="text" id="materiaNombre" class="w-full px-4 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
            </div>
            <div class="mb-4">
                <label for="materiaSemestre" class="block text-gray-700 font-medium mb-2">Semestre:</label>
                <select id="materiaSemestre" class="w-full px-4 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    <!-- Se llenará dinámicamente -->
                </select>
            </div>
            <div class="mb-4">
                <label for="materiaHoras" class="block text-gray-700 font-medium mb-2" title="Número de bloques de clase por semana (la duración del bloque se define en Configuración)">Bloques por Semana:</label>
                <input type="number" id="materiaHoras" min="1" max="10" class="w-full px-4 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
            </div>
            <div class="mb-4">
                <label for="materiaTipoAula" class="block text-gray-700 font-medium mb-2">Tipo de Aula Requerido:</label>
                <select id="materiaTipoAula" class="w-full px-4 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    <option value="normal">Normal</option>
                    <option value="laboratorio">Laboratorio</option>
                    <option value="informatica">Informática</option>
                    <option value="auditorio">Auditorio</option>
                </select>
            </div>
             <!-- Se eliminó Profesor Preferido -->
            <div class="mt-6 flex justify-end">
                <button id="cancelarMateriaBtn" type="button" class="px-4 py-2 bg-gray-300 text-gray-700 rounded-md mr-2">Cancelar</button>
                <button id="guardarMateriaBtn" type="button" class="px-4 py-2 bg-blue-600 text-white rounded-md">Guardar</button>
            </div>
        </div>
    </div>

    <!-- Modal para Aulas -->
    <div id="modalAula" class="fixed inset-0 bg-black bg-opacity-50 items-center justify-center hidden z-50 no-print">
        <div class="bg-white p-6 rounded-lg shadow-lg w-11/12 md:w-2/3 lg:w-1/2 max-h-90vh overflow-y-auto">
            <h2 class="text-xl font-bold mb-4" id="modalAulaTitulo">Datos del Aula</h2>
             <input type="hidden" id="aulaEditId">
            <div class="mb-4">
                <label for="aulaCodigo" class="block text-gray-700 font-medium mb-2">Código:</label>
                <input type="text" id="aulaCodigo" class="w-full px-4 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
            </div>
            <div class="mb-4">
                <label for="aulaNombre" class="block text-gray-700 font-medium mb-2">Nombre:</label>
                <input type="text" id="aulaNombre" class="w-full px-4 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
            </div>
            <div class="mb-4">
                <label for="aulaTipo" class="block text-gray-700 font-medium mb-2">Tipo:</label>
                <select id="aulaTipo" class="w-full px-4 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    <option value="normal">Normal</option>
                    <option value="laboratorio">Laboratorio</option>
                    <option value="informatica">Informática</option>
                    <option value="auditorio">Auditorio</option>
                </select>
            </div>
            <div class="mb-4">
                <label for="aulaCapacidad" class="block text-gray-700 font-medium mb-2">Capacidad:</label>
                <input type="number" id="aulaCapacidad" min="1" max="500" class="w-full px-4 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
            </div>
            <div class="mb-4">
                <label for="aulaUbicacion" class="block text-gray-700 font-medium mb-2">Ubicación:</label>
                <input type="text" id="aulaUbicacion" class="w-full px-4 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
            <div class="mt-6 flex justify-end">
                <button id="cancelarAulaBtn" type="button" class="px-4 py-2 bg-gray-300 text-gray-700 rounded-md mr-2">Cancelar</button>
                <button id="guardarAulaBtn" type="button" class="px-4 py-2 bg-blue-600 text-white rounded-md">Guardar</button>
            </div>
        </div>
    </div>

    <!-- Modal de Edición de Sesión de Horario -->
    <div id="modalSesion" class="fixed inset-0 bg-black bg-opacity-50 items-center justify-center hidden z-50 no-print">
        <div class="bg-white p-6 rounded-lg shadow-lg w-11/12 md:w-2/3 lg:w-1/2 max-h-90vh overflow-y-auto">
            <h2 class="text-xl font-bold mb-4">Editar Sesión de Clase</h2>
            <input type="hidden" id="sesionDia">
            <input type="hidden" id="sesionHora">
            <input type="hidden" id="sesionSemestre">
            <input type="hidden" id="sesionOriginalMateriaId"> <!-- Para saber qué materia se está editando -->

            <div class="mb-4">
                <label for="sesionMateria" class="block text-gray-700 font-medium mb-2">Materia:</label>
                <select id="sesionMateria" class="w-full px-4 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    <!-- Opciones cargadas dinámicamente -->
                </select>
            </div>
            <div class="mb-4">
                <label for="sesionProfesor" class="block text-gray-700 font-medium mb-2">Profesor:</label>
                <select id="sesionProfesor" class="w-full px-4 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    <!-- Opciones cargadas dinámicamente -->
                </select>
            </div>
            <div class="mb-4">
                <label for="sesionAula" class="block text-gray-700 font-medium mb-2">Aula:</label>
                <select id="sesionAula" class="w-full px-4 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    <!-- Opciones cargadas dinámicamente -->
                </select>
            </div>
            <div class="mb-4">
                <div class="flex items-center">
                    <input type="checkbox" id="sesionFijada" class="mr-2">
                    <label for="sesionFijada" class="text-gray-700">Fijar esta sesión (no se moverá al optimizar)</label>
                </div>
            </div>
            <div class="mt-6 flex justify-between"> <!-- Cambiado a justify-between -->
                <button id="eliminarSesionBtn" type="button" class="px-4 py-2 bg-red-600 text-white rounded-md">Eliminar Sesión</button>
                <div>
                    <button id="cancelarSesionBtn" type="button" class="px-4 py-2 bg-gray-300 text-gray-700 rounded-md mr-2">Cancelar</button>
                    <button id="guardarSesionBtn" type="button" class="px-4 py-2 bg-blue-600 text-white rounded-md">Guardar Cambios</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para informes y resultados -->
    <div id="modalInforme" class="fixed inset-0 bg-black bg-opacity-50 items-center justify-center hidden z-50 no-print">
        <div class="bg-white p-6 rounded-lg shadow-lg w-11/12 md:w-3/4 max-h-90vh overflow-y-auto">
            <h2 class="text-xl font-bold mb-4" id="tituloInforme">Informe de Generación</h2>
            <div id="contenidoInforme" class="mb-6 text-sm">
                <!-- El contenido del informe se generará dinámicamente -->
            </div>
            <div class="mt-6 flex justify-end">
                <button id="cerrarInformeBtn" type="button" class="px-4 py-2 bg-blue-600 text-white rounded-md">Cerrar</button>
            </div>
        </div>
    </div>

    <!-- Script principal -->
    <script>
        // Estado global de la aplicación
        const estado = {
            profesores: [], // { id, codigo, nombre, especialidad, diasDisponibles: { Lunes: { mañana: bool, tarde: bool }, ... }, materiasQueDicta: [materiaId1, ...], horasInvestigacionSemanal, horasProyectosInstSemanal, horasProyectosExtSemanal, horasCapacitacionSemestral, horasMaterialDidacticoSemanal, horasObjetivoSemanal }
            materias: [],   // { id, codigo, nombre, semestre, horasSemana, tipoAula } // horasSemana = número de bloques
            aulas: [],      // { id, codigo, nombre, tipo, capacidad, ubicacion }
            restricciones: [], // { tipo: 'horarioFijo', profesorId, materiaId, aulaId, semestre, dia, hora } o { tipo: 'evitarHuecos', peso } etc.
            horarios: {},   // { semestre: { dia: { hora: { materia, codigo, profesor, profesorId, aula, aulaId, fijado } } } }
            horariosAsesorias: {}, // { profesorId: { dia: { hora: { tipo: 'asesoria', duracion } } } } // Placeholder, no implementado visualmente aún
            horariosVisualizacion: { // Estructuras precalculadas para diferentes vistas
                porSemestre: {}, // Incluye clases regulares
                porProfesor: {},
                porAula: {},
                porMateria: {}
            },
            modoEdicion: false,
            configuracion: {
                periodoAcademico: "semestral",
                cantidadSemestres: 4,
                horaInicio: "06:00",
                horaFin: "18:00",
                duracionBloque: 60,
                diasDisponibles: ["Lunes", "Martes", "Miércoles", "Jueves", "Viernes"], // Inicializado por defecto
                // Configuración detallada de asesorías
                asesoriasNormalesConfig: {
                    habilitado: false,
                    duracionMinutos: 60,
                    vecesPorSemana: 1
                },
                asesoriasEvaluacionConfig: {
                    habilitado: false,
                    duracionMinutos: 120,
                    vecesPorSemana: 1
                },
                // Campos antiguos de asesorías (se mantienen por si acaso, pero no se usan en la nueva lógica)
                habilitarAsesorias: false, // Obsoleto
                duracionAsesoria: 30 // Obsoleto
            },
            editandoId: null // ID del elemento actualmente en edición en un modal
        };

        // --- INICIALIZACIÓN ---
        document.addEventListener('DOMContentLoaded', () => {
            cargarDatosGuardados();
            setupTabs();
            setupEventListeners();
            setupEventosAdicionales();
            renderizarTodo();
            actualizarInterfaz(); // Asegura que la UI refleje el estado cargado
            actualizarEstadoBotones(); // Habilitar/deshabilitar botones según datos
        });

        // --- GESTIÓN DE PESTAÑAS ---
        function setupTabs() {
            const tabs = document.querySelectorAll('.tab-link');
            const contents = document.querySelectorAll('.tab-content');
            tabs.forEach(tab => {
                tab.addEventListener('click', (e) => {
                    e.preventDefault();
                    const targetId = e.target.getAttribute('href').substring(1);

                    tabs.forEach(t => t.classList.remove('bg-blue-600', 'active')); // Quita active de todos
                    e.target.classList.add('bg-blue-600', 'active'); // Añade active al clickeado

                    contents.forEach(content => {
                        if (content.id === targetId) {
                            content.classList.add('active');
                        } else {
                            content.classList.remove('active');
                        }
                    });
                    // Si se cambia a la pestaña de horarios, actualizar la vista
                    if (targetId === 'horarios') {
                         actualizarHorarioVisible(); // Actualiza ambas tablas (regular y asesorías)
                    }
                    // Si se cambia a la pestaña de profesores, recalcular y renderizar resumen detallado
                    if (targetId === 'profesores') {
                        renderizarProfesores(); // Asegura que el resumen detallado se muestre
                    }
                });
            });
             // Activar la pestaña guardada o la primera por defecto
            const activeTabHash = window.location.hash || '#configuracion';
            const activeTabLink = document.querySelector(`.tab-link[href="${activeTabHash}"]`);
            if (activeTabLink) {
                activeTabLink.click(); // Simula clic para activar la pestaña correcta
            } else {
                 tabs[0].click(); // Activa la primera si el hash no es válido
            }
        }

        // --- CONFIGURACIÓN DE EVENTOS PRINCIPALES ---
        function setupEventListeners() {
            // Configuración
            document.getElementById('saveConfigBtn').addEventListener('click', guardarConfiguracion);
            document.getElementById('cantidadSemestres').addEventListener('change', actualizarInterfaz); // Actualizar selectores si cambia
            // Eventos para nueva config de asesorías
            document.getElementById('habilitarAsesoriasNormales').addEventListener('change', guardarConfiguracion);
            document.getElementById('duracionAsesoriaNormal').addEventListener('change', guardarConfiguracion);
            document.getElementById('frecuenciaAsesoriaNormal').addEventListener('change', guardarConfiguracion);
            document.getElementById('habilitarAsesoriasEvaluacion').addEventListener('change', guardarConfiguracion);
            document.getElementById('duracionAsesoriaEvaluacion').addEventListener('change', guardarConfiguracion);
            document.getElementById('frecuenciaAsesoriaEvaluacion').addEventListener('change', guardarConfiguracion);
            // Fin eventos nueva config asesorías
            document.querySelectorAll('.dia-semana-check').forEach(chk => chk.addEventListener('change', guardarConfiguracion)); // Guardar al cambiar días

            // Importar/Exportar/Ejemplo
            document.getElementById('cargarDatosExcel').addEventListener('click', cargarDatosDesdeExcel);
            document.getElementById('importBtn').addEventListener('click', () => document.getElementById('excelFileInput').click());
            document.getElementById('excelFileInput').addEventListener('change', () => {
                if (document.getElementById('excelFileInput').files.length > 0) {
                    cargarDatosDesdeExcel();
                }
            });
            document.getElementById('cargarDatosEjemplo').addEventListener('click', cargarDatosEjemplo);
            document.getElementById('formatoExportacion').addEventListener('change', togglePdfOptionsVisibility);
            document.getElementById('doExportBtn').addEventListener('click', exportarHorarios); // Button inside the menu triggers export


            // Gestión CRUD (botones Añadir y modales)
            document.getElementById('addProfesorBtn').addEventListener('click', () => mostrarModalProfesor());
            document.getElementById('guardarProfesorBtn').addEventListener('click', guardarProfesor);
            document.getElementById('cancelarProfesorBtn').addEventListener('click', () => cerrarModal('modalProfesor'));

            document.getElementById('addMateriaBtn').addEventListener('click', () => mostrarModalMateria());
            document.getElementById('guardarMateriaBtn').addEventListener('click', guardarMateria);
            document.getElementById('cancelarMateriaBtn').addEventListener('click', () => cerrarModal('modalMateria'));

            document.getElementById('addAulaBtn').addEventListener('click', () => mostrarModalAula());
            document.getElementById('guardarAulaBtn').addEventListener('click', guardarAula);
            document.getElementById('cancelarAulaBtn').addEventListener('click', () => cerrarModal('modalAula'));

            // Búsqueda y Filtros
            document.getElementById('buscarProfesor').addEventListener('input', () => filtrarTabla('tablaProfesores', 'buscarProfesor', 1));
            document.getElementById('buscarMateria').addEventListener('input', () => filtrarTabla('tablaMaterias', 'buscarMateria', 1));
            document.getElementById('buscarAula').addEventListener('input', () => filtrarTabla('tablaAulas', 'buscarAula', 1));
            document.getElementById('filtroTipoAula').addEventListener('change', filtrarAulasPorTipo);

            // Restricciones
            document.getElementById('guardarRestricciones').addEventListener('click', guardarRestricciones);
            document.getElementById('fijarHorarioBtn').addEventListener('click', fijarHorarioProfesor);
            document.getElementById('profesorRestriccion').addEventListener('change', cargarMateriasParaRestriccion);
            document.getElementById('materiaRestriccion').addEventListener('change', cargarAulasParaRestriccion);

            // Horarios
            document.getElementById('generarHorariosBtn').addEventListener('click', generarHorarios);
            document.getElementById('generarHorariosBtnAlt').addEventListener('click', generarHorarios);
            document.getElementById('optimizarHorariosBtn').addEventListener('click', optimizarHorarios);
            document.getElementById('modoEdicionBtn').addEventListener('click', toggleModoEdicion);
            document.getElementById('filtroVistaHorario').addEventListener('change', cambiarVistaHorario);
            document.getElementById('elementoSeleccionado').addEventListener('change', actualizarHorarioVisible);

            // Modal Edición Sesión
            document.getElementById('guardarSesionBtn').addEventListener('click', guardarSesionEditada);
            document.getElementById('cancelarSesionBtn').addEventListener('click', () => cerrarModal('modalSesion'));
            document.getElementById('eliminarSesionBtn').addEventListener('click', eliminarSesion);

            // Modal Informe
            document.getElementById('cerrarInformeBtn').addEventListener('click', () => cerrarModal('modalInforme'));

             // Edición en celdas (delegación de eventos)
            document.addEventListener('click', function(e) {
                const cell = e.target.closest('.editable-cell');
                if (cell) {
                    const type = cell.dataset.type;
                    const id = cell.dataset.id;
                    const field = cell.dataset.field;
                    // Evitar edición en la columna de carga total en la tabla principal de profesores
                    if (type === 'profesor' && field === 'cargaTotal') return;

                    if (type && id && field && !cell.querySelector('input, select')) { // Evitar re-editar si ya hay input
                        editarCeldaDinamica(type, id, field, cell);
                    }
                }
            });

             // Edición de sesión de horario (doble clic)
            document.getElementById('horarioContainer').addEventListener('dblclick', function(e) {
                const sessionDiv = e.target.closest('.session');
                if (sessionDiv && estado.modoEdicion) {
                    const dia = sessionDiv.dataset.dia;
                    const hora = sessionDiv.dataset.hora;
                    const materiaCodigo = sessionDiv.dataset.materia; // Usamos el código/id de materia

                    // Buscar el semestre
                    let semestreEncontrado = null;
                    for (const sem in estado.horarios) {
                        if (estado.horarios[sem][dia] && estado.horarios[sem][dia][hora] && estado.horarios[sem][dia][hora].codigo === materiaCodigo) {
                            semestreEncontrado = sem;
                            break;
                        }
                    }

                    if (semestreEncontrado) {
                        mostrarModalSesion(dia, hora, semestreEncontrado);
                    } else {
                        console.warn("No se pudo encontrar el semestre para la sesión:", dia, hora, materiaCodigo);
                    }
                }
            });
        }

        // --- EVENTOS ADICIONALES Y CONFIGURACIONES SECUNDARIAS ---
        function setupEventosAdicionales() {
            actualizarSelectorTipoVista(); // Configurar selector inicial de vista de horario
            actualizarSelectoresHorariosFijos(); // Poblar selectores de restricciones
            actualizarSelectorSemestres(); // Poblar selector de semestre en modal materia
            renderizarListaHorariosFijos(); // Mostrar horarios fijos guardados
        }

        // --- RENDERIZACIÓN ---
        function renderizarTodo() {
            renderizarProfesores();
            renderizarMaterias();
            renderizarAulas();
            renderizarListaHorariosFijos(); // En pestaña restricciones
            // El horario se renderiza bajo demanda con actualizarHorarioVisible()
        }

        // Renderizar tabla de profesores y resumen detallado
        function renderizarProfesores() {
            const tbody = document.getElementById('tablaProfesores').querySelector('tbody');
            tbody.innerHTML = ''; // Limpiar tabla principal

            if (!estado.profesores || estado.profesores.length === 0) {
                tbody.innerHTML = `<tr><td colspan="5" class="py-4 px-6 text-center">No hay profesores registrados.</td></tr>`;
                // Limpiar también el resumen detallado
                const resumenTbody = document.getElementById('resumenCargaProfesores').querySelector('tbody');
                if (resumenTbody) resumenTbody.innerHTML = `<tr><td colspan="10" class="py-3 px-4 text-center text-gray-500">No hay profesores para mostrar carga.</td></tr>`;
                return;
            }

            // Calcular carga detallada una vez
            const cargaDetalladaProfesores = calcularCargaProfesoresDetallada();

            // Poblar tabla principal de profesores
            estado.profesores.forEach(profesor => {
                const row = document.createElement('tr');
                const materiasAsignadas = profesor.materiasQueDicta?.map(matId => estado.materias.find(m => m.id === matId)?.nombre).filter(Boolean).join(', ') || 'Ninguna';
                const cargaTotalHoras = cargaDetalladaProfesores[profesor.id]?.total || 0;

                row.innerHTML = `
                    <td class="py-3 px-6 editable-cell" data-type="profesor" data-id="${profesor.id}" data-field="codigo">${profesor.codigo || ''}</td>
                    <td class="py-3 px-6 editable-cell" data-type="profesor" data-id="${profesor.id}" data-field="nombre">${profesor.nombre || ''}</td>
                    <td class="py-3 px-6 editable-cell" data-type="profesor" data-id="${profesor.id}" data-field="especialidad">${profesor.especialidad || 'No especificada'}</td>
                    <td class="py-3 px-6 text-xs editable-cell" data-type="profesor" data-id="${profesor.id}" data-field="cargaTotal" title="${materiasAsignadas}">Materias: ${materiasAsignadas.substring(0, 30)}${materiasAsignadas.length > 30 ? '...' : ''} <br> Carga Total: ${cargaTotalHoras} h</td>
                    <td class="py-3 px-6 text-center no-print">
                         <button onclick="mostrarModalProfesor('${profesor.id}')" class="bg-blue-100 hover:bg-blue-200 text-blue-800 text-xs px-2 py-1 rounded no-print mr-1" title="Ver/Editar Disponibilidad, Materias y Carga">
                            Detalles
                        </button>
                        <button class="bg-yellow-500 hover:bg-yellow-700 text-white p-1 rounded mr-1" onclick="mostrarModalProfesor('${profesor.id}')" title="Editar Profesor">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" /></svg>
                        </button>
                        <button class="bg-red-500 hover:bg-red-700 text-white p-1 rounded" onclick="eliminarProfesor('${profesor.id}')" title="Eliminar Profesor">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });

            // Renderizar resumen de carga horaria detallado
            const resumenContainer = document.getElementById('resumenCargaProfesores');
            const resumenTbody = resumenContainer.querySelector('tbody');
            let resumenTbodyHtml = '';

            if (estado.profesores.length > 0) {
                estado.profesores.sort((a, b) => a.nombre.localeCompare(b.nombre)).forEach(prof => {
                    const carga = cargaDetalladaProfesores[prof.id];
                    if (!carga) return; // Si no hay datos para este profesor
                    resumenTbodyHtml += `<tr class="border-b border-gray-200 hover:bg-gray-100">
                                    <td class="py-2 px-3 text-left">${prof.nombre}</td>
                                    <td class="py-2 px-3 text-center">${carga.clases}</td>
                                    <td class="py-2 px-3 text-center">${carga.asesoriaNormal}</td>
                                    <td class="py-2 px-3 text-center">${carga.asesoriaEvaluacion}</td>
                                    <td class="py-2 px-3 text-center">${carga.investigacion}</td>
                                    <td class="py-2 px-3 text-center">${carga.proyectosInst}</td>
                                    <td class="py-2 px-3 text-center">${carga.proyectosExt}</td>
                                    <td class="py-2 px-3 text-center">${carga.materialDidactico}</td>
                                    <td class="py-2 px-3 text-center">${carga.capacitacion}</td>
                                    <td class="py-2 px-3 text-center font-bold">${carga.total}</td>
                                    <!-- Opcional: <td class="py-2 px-3 text-center">${carga.objetivo || '-'}</td> -->
                                  </tr>`;
                });
            } else {
                resumenTbodyHtml = `<tr><td colspan="10" class="py-3 px-4 text-center text-gray-500">No hay profesores para mostrar carga.</td></tr>`; // Ajustar colspan
            }
            if (resumenTbody) resumenTbody.innerHTML = resumenTbodyHtml;
        }


        // Renderizar tabla de materias
        function renderizarMaterias() {
            const tbody = document.getElementById('tablaMaterias').querySelector('tbody');
            tbody.innerHTML = '';

            if (!estado.materias || estado.materias.length === 0) {
                tbody.innerHTML = `<tr><td colspan="6" class="py-4 px-6 text-center">No hay materias registradas.</td></tr>`;
                return;
            }

            estado.materias.forEach(materia => {

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="py-3 px-6 editable-cell" data-type="materia" data-id="${materia.id}" data-field="codigo">${materia.codigo || ''}</td>
                    <td class="py-3 px-6 editable-cell" data-type="materia" data-id="${materia.id}" data-field="nombre">${materia.nombre || ''}</td>
                    <td class="py-3 px-6 editable-cell" data-type="materia" data-id="${materia.id}" data-field="semestre">${materia.semestre || 'N/A'}</td>
                    <td class="py-3 px-6 editable-cell" data-type="materia" data-id="${materia.id}" data-field="horasSemana">${materia.horasSemana || 0}</td>
                    <td class="py-3 px-6 editable-cell" data-type="materia" data-id="${materia.id}" data-field="tipoAula">${materia.tipoAula || 'normal'}</td>
                    <td class="py-3 px-6 text-center no-print">
                        <button class="bg-yellow-500 hover:bg-yellow-700 text-white p-1 rounded mr-1" onclick="mostrarModalMateria('${materia.id}')" title="Editar Materia">
                           <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" /></svg>
                        </button>
                        <button class="bg-red-500 hover:bg-red-700 text-white p-1 rounded" onclick="eliminarMateria('${materia.id}')" title="Eliminar Materia">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // Renderizar tabla de aulas
        function renderizarAulas() {
            const tbody = document.getElementById('tablaAulas').querySelector('tbody');
            tbody.innerHTML = '';
            const filtroTipo = document.getElementById('filtroTipoAula').value;

            if (!estado.aulas || estado.aulas.length === 0) {
                tbody.innerHTML = `<tr><td colspan="6" class="py-4 px-6 text-center">No hay aulas registradas.</td></tr>`;
                return;
            }

            const aulasFiltradas = filtroTipo === 'todos'
                ? estado.aulas
                : estado.aulas.filter(aula => aula.tipo === filtroTipo);

             if (aulasFiltradas.length === 0) {
                tbody.innerHTML = `<tr><td colspan="6" class="py-4 px-6 text-center">No hay aulas del tipo '${filtroTipo}'.</td></tr>`;
                return;
            }

            aulasFiltradas.forEach(aula => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="py-3 px-6 editable-cell" data-type="aula" data-id="${aula.id}" data-field="codigo">${aula.codigo || ''}</td>
                    <td class="py-3 px-6 editable-cell" data-type="aula" data-id="${aula.id}" data-field="nombre">${aula.nombre || ''}</td>
                    <td class="py-3 px-6 editable-cell" data-type="aula" data-id="${aula.id}" data-field="tipo">${aula.tipo || 'normal'}</td>
                    <td class="py-3 px-6 editable-cell" data-type="aula" data-id="${aula.id}" data-field="capacidad">${aula.capacidad || 0}</td>
                    <td class="py-3 px-6 editable-cell" data-type="aula" data-id="${aula.id}" data-field="ubicacion">${aula.ubicacion || 'N/A'}</td>
                    <td class="py-3 px-6 text-center no-print">
                        <button class="bg-yellow-500 hover:bg-yellow-700 text-white p-1 rounded mr-1" onclick="mostrarModalAula('${aula.id}')" title="Editar Aula">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" /></svg>
                        </button>
                        <button class="bg-red-500 hover:bg-red-700 text-white p-1 rounded" onclick="eliminarAula('${aula.id}')" title="Eliminar Aula">
                           <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // Renderizar la lista de horarios fijos en la pestaña de restricciones
        function renderizarListaHorariosFijos() {
            const listaUl = document.getElementById('listaHorariosFijos').querySelector('ul');
            listaUl.innerHTML = ''; // Limpiar lista

            const horariosFijos = estado.restricciones.filter(r => r.tipo === 'horarioFijo');

            if (horariosFijos.length === 0) {
                listaUl.innerHTML = '<li>No hay horarios fijos definidos.</li>';
                return;
            }

            horariosFijos.forEach((restriccion, index) => {
                const profesor = estado.profesores.find(p => p.id === restriccion.profesorId)?.nombre || 'Prof. Desconocido';
                const materia = estado.materias.find(m => m.id === restriccion.materiaId)?.nombre || 'Mat. Desconocida';
                const aula = estado.aulas.find(a => a.id === restriccion.aulaId)?.nombre || 'Aula Desconocida';

                const li = document.createElement('li');
                li.className = 'mb-1 flex justify-between items-center';
                li.innerHTML = `
                    <span>${profesor} - ${materia} - ${aula} (${restriccion.dia} ${restriccion.hora})</span>
                    <button class="text-red-500 hover:text-red-700 text-xs ml-2 no-print" onclick="eliminarHorarioFijo(${index})" title="Eliminar restricción">&times;</button>
                `;
                listaUl.appendChild(li);
            });
        }

        // --- EDICIÓN EN CELDAS ---
        function editarCeldaDinamica(tipo, id, campo, celda) {
            // Prevenir edición de la columna de carga total en la tabla de profesores
            if (tipo === 'profesor' && campo === 'cargaTotal') {
                mostrarNotificacion('Info', 'La carga total se calcula automáticamente.', 'info');
                return;
            }

            const valorActual = celda.textContent.trim();
            let inputElement;

            // Crear campo de edición según el tipo de campo
            if (campo === 'tipo' && tipo === 'aula') {
                inputElement = document.createElement('select');
                ['normal', 'laboratorio', 'informatica', 'auditorio'].forEach(opcion => {
                    const option = document.createElement('option');
                    option.value = opcion; option.textContent = opcion;
                    if (opcion === valorActual) option.selected = true;
                    inputElement.appendChild(option);
                });
            } else if (campo === 'semestre' && tipo === 'materia') {
                inputElement = document.createElement('select');
                const cantidadSemestres = parseInt(estado.configuracion.cantidadSemestres) || 4;
                for (let i = 1; i <= cantidadSemestres; i++) {
                    const option = document.createElement('option');
                    option.value = i; option.textContent = i;
                    if (i === parseInt(valorActual)) option.selected = true;
                    inputElement.appendChild(option);
                }
            } else if (['horasSemana', 'capacidad'].includes(campo)) {
                inputElement = document.createElement('input');
                inputElement.type = 'number';
                inputElement.min = (campo === 'horasSemana') ? '1' : '1';
                inputElement.max = (campo === 'horasSemana') ? '10' : '500';
                inputElement.value = parseInt(valorActual) || inputElement.min;
            } else { // Campos de texto (codigo, nombre, especialidad, ubicacion)
                inputElement = document.createElement('input');
                inputElement.type = 'text';
                inputElement.value = valorActual;
            }

            inputElement.className = 'px-1 py-0 border rounded w-full text-sm'; // Estilo compacto
            celda.innerHTML = '';
            celda.appendChild(inputElement);
            inputElement.focus();
            inputElement.select(); // Seleccionar texto para fácil reemplazo

            // Función para guardar el cambio
            const guardarCambio = () => {
                let nuevoValor = inputElement.value.trim();
                // Validar que no esté vacío si es código o nombre
                if (['codigo', 'nombre'].includes(campo) && !nuevoValor) {
                     mostrarNotificacion('Error', `El campo ${campo} no puede estar vacío.`, 'error');
                     celda.innerHTML = valorActual; // Restaurar valor original
                     return;
                }

                if (nuevoValor !== valorActual) {
                    let objeto;
                    if (tipo === 'profesor') objeto = estado.profesores.find(p => p.id == id);
                    else if (tipo === 'materia') objeto = estado.materias.find(m => m.id == id);
                    else if (tipo === 'aula') objeto = estado.aulas.find(a => a.id == id);

                    if (objeto) {
                        // Convertir a número si es necesario
                        if (['horasSemana', 'capacidad', 'semestre'].includes(campo)) {
                            nuevoValor = parseInt(nuevoValor);
                            if (isNaN(nuevoValor)) {
                                mostrarNotificacion('Error', 'Valor numérico inválido.', 'error');
                                celda.innerHTML = valorActual;
                                return;
                            }
                        }

                        // Validar unicidad del código si se está cambiando
                        if (campo === 'codigo') {
                            const existe = estado[tipo + 's'].some(item => item.codigo === nuevoValor && item.id !== id);
                            if (existe) {
                                 mostrarNotificacion('Error', `El código '${nuevoValor}' ya está en uso.`, 'error');
                                 celda.innerHTML = valorActual;
                                 return;
                            }
                        }

                        objeto[campo] = nuevoValor; // Actualizar la propiedad

                        guardarDatosLocalmente();

                        // Actualizar solo la celda en la UI para eficiencia
                        celda.textContent = nuevoValor; // Mostrar el nuevo valor

                        // Re-renderizar profesores si se cambió algo que afecta el resumen
                        if (tipo === 'profesor') {
                            renderizarProfesores();
                        } else if (tipo === 'materia') {
                            renderizarMaterias();
                            renderizarProfesores(); // La carga puede cambiar si cambian horas de materia
                        } else if (tipo === 'aula') {
                            renderizarAulas();
                        }

                        mostrarNotificacion('Actualización', `Campo ${campo} actualizado.`, 'success');
                        actualizarInterfaz(); // Actualizar selectores y otros elementos dependientes
                    } else {
                         mostrarNotificacion('Error', 'No se encontró el elemento para actualizar.', 'error');
                         celda.innerHTML = valorActual;
                    }
                } else {
                    // Si no hubo cambio, restaurar
                    celda.innerHTML = valorActual;
                }
                 // Quitar listeners para evitar duplicados
                inputElement.removeEventListener('blur', guardarCambio);
                inputElement.removeEventListener('keydown', handleKeyDown);
            };

             const handleKeyDown = (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    guardarCambio();
                } else if (e.key === 'Escape') {
                    celda.innerHTML = valorActual; // Cancelar
                    inputElement.removeEventListener('blur', guardarCambio);
                    inputElement.removeEventListener('keydown', handleKeyDown);
                }
            };

            // Eventos para guardar
            inputElement.addEventListener('blur', guardarCambio);
            inputElement.addEventListener('keydown', handleKeyDown);
        }


        // --- GESTIÓN DE DATOS (CRUD) ---

        // Mostrar modal Profesor (Añadir o Editar)
        function mostrarModalProfesor(profesorId = null) {
            const modal = document.getElementById('modalProfesor');
            const titulo = document.getElementById('modalProfesorTitulo');
            const codigoInput = document.getElementById('profesorCodigo');
            const nombreInput = document.getElementById('profesorNombre');
            const especialidadInput = document.getElementById('profesorEspecialidad');
            const editIdInput = document.getElementById('profesorEditId');
            const materiasContainer = document.getElementById('profesorMateriasContainer');
            const checkboxesDisp = modal.querySelectorAll('.disp-check');
            // Inputs de carga laboral
            const investigacionInput = document.getElementById('profesorInvestigacion');
            const proyInstInput = document.getElementById('profesorProyectosInst');
            const proyExtInput = document.getElementById('profesorProyectosExt');
            const materialInput = document.getElementById('profesorMaterial');
            const capacitacionInput = document.getElementById('profesorCapacitacion');
            // const horasObjetivoInput = document.getElementById('profesorHorasObjetivo'); // Opcional

            if (profesorId) { // Modo Edición
                const profesor = estado.profesores.find(p => p.id === profesorId);
                if (!profesor) return;
                titulo.textContent = 'Editar Profesor';
                codigoInput.value = profesor.codigo;
                nombreInput.value = profesor.nombre;
                especialidadInput.value = profesor.especialidad || '';
                editIdInput.value = profesorId;
                estado.editandoId = profesorId; // Guardar ID para 'guardarProfesor'

                // Cargar carga laboral
                investigacionInput.value = profesor.horasInvestigacionSemanal || 0;
                proyInstInput.value = profesor.horasProyectosInstSemanal || 0;
                proyExtInput.value = profesor.horasProyectosExtSemanal || 0;
                materialInput.value = profesor.horasMaterialDidacticoSemanal || 0;
                capacitacionInput.value = profesor.horasCapacitacionSemestral || 0;
                // if (horasObjetivoInput) horasObjetivoInput.value = profesor.horasObjetivoSemanal || '';

                // Cargar materias que dicta
                materiasContainer.innerHTML = ''; // Limpiar
                estado.materias.sort((a,b) => a.nombre.localeCompare(b.nombre)).forEach(materia => {
                    const isChecked = profesor.materiasQueDicta?.includes(materia.id) ?? false;
                    materiasContainer.innerHTML += `
                        <div class="flex items-center">
                            <input type="checkbox" id="profMat-${materia.id}" value="${materia.id}" class="mr-1 prof-materia-check" ${isChecked ? 'checked' : ''}>
                            <label for="profMat-${materia.id}" class="text-sm" title="${materia.nombre} (Sem ${materia.semestre})">${materia.nombre}</label>
                        </div>
                    `;
                });

                // Cargar disponibilidad guardada
                checkboxesDisp.forEach(chk => {
                    const dia = chk.dataset.dia;
                    const turno = chk.dataset.turno;
                    chk.checked = profesor.diasDisponibles?.[dia]?.[turno] ?? false; // Usar valor guardado o false
                });

            } else { // Modo Añadir
                titulo.textContent = 'Añadir Nuevo Profesor';
                codigoInput.value = '';
                nombreInput.value = '';
                especialidadInput.value = '';
                editIdInput.value = '';
                estado.editandoId = null;

                // Resetear carga laboral
                investigacionInput.value = 0;
                proyInstInput.value = 0;
                proyExtInput.value = 0;
                materialInput.value = 0;
                capacitacionInput.value = 0;
                // if (horasObjetivoInput) horasObjetivoInput.value = '';

                // Cargar materias (ninguna seleccionada por defecto)
                materiasContainer.innerHTML = ''; // Limpiar
                 estado.materias.sort((a,b) => a.nombre.localeCompare(b.nombre)).forEach(materia => {
                    materiasContainer.innerHTML += `
                        <div class="flex items-center">
                            <input type="checkbox" id="profMat-${materia.id}" value="${materia.id}" class="mr-1 prof-materia-check">
                            <label for="profMat-${materia.id}" class="text-sm" title="${materia.nombre} (Sem ${materia.semestre})">${materia.nombre}</label>
                        </div>
                    `;
                });


                 // Establecer disponibilidad por defecto (ej. L-V Mañana y Tarde)
                checkboxesDisp.forEach(chk => {
                    const dia = chk.dataset.dia;
                    chk.checked = (dia !== 'Sábado'); // Marcar L-V por defecto
                });
            }
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        // Guardar Profesor (Añadir o Editar)
        function guardarProfesor() {
            const id = estado.editandoId;
            const codigo = document.getElementById('profesorCodigo').value.trim();
            const nombre = document.getElementById('profesorNombre').value.trim();
            const especialidad = document.getElementById('profesorEspecialidad').value.trim();
            const materiasChecks = document.querySelectorAll('#modalProfesor .prof-materia-check:checked');
            const checkboxesDisp = document.querySelectorAll('#modalProfesor .disp-check');
            // Leer carga laboral
            const horasInvestigacionSemanal = parseFloat(document.getElementById('profesorInvestigacion').value) || 0;
            const horasProyectosInstSemanal = parseFloat(document.getElementById('profesorProyectosInst').value) || 0;
            const horasProyectosExtSemanal = parseFloat(document.getElementById('profesorProyectosExt').value) || 0;
            const horasMaterialDidacticoSemanal = parseFloat(document.getElementById('profesorMaterial').value) || 0;
            const horasCapacitacionSemestral = parseFloat(document.getElementById('profesorCapacitacion').value) || 0;
            // const horasObjetivoSemanalInput = document.getElementById('profesorHorasObjetivo'); // Opcional
            // const horasObjetivoSemanal = horasObjetivoSemanalInput ? (parseFloat(horasObjetivoSemanalInput.value) || null) : null;

            if (!codigo || !nombre) {
                mostrarNotificacion('Error', 'El código y el nombre son obligatorios.', 'error');
                return;
            }

            // Validar que el código no exista ya (si es nuevo o si se cambió)
            const codigoExiste = estado.profesores.some(p => p.codigo === codigo && p.id !== id);
            if (codigoExiste) {
                 mostrarNotificacion('Error', `El código '${codigo}' ya está en uso por otro profesor.`, 'error');
                 return;
            }

            // Recopilar materias seleccionadas
            const materiasQueDicta = [];
            materiasChecks.forEach(chk => materiasQueDicta.push(chk.value));

            // Recopilar disponibilidad
            const diasDisponibles = {};
             checkboxesDisp.forEach(chk => {
                const dia = chk.dataset.dia;
                const turno = chk.dataset.turno;
                if (!diasDisponibles[dia]) {
                    diasDisponibles[dia] = {};
                }
                diasDisponibles[dia][turno] = chk.checked;
            });


            if (id) { // Editar
                const profesor = estado.profesores.find(p => p.id === id);
                if (profesor) {
                    profesor.codigo = codigo;
                    profesor.nombre = nombre;
                    profesor.especialidad = especialidad;
                    profesor.diasDisponibles = diasDisponibles;
                    profesor.materiasQueDicta = materiasQueDicta;
                    // Actualizar carga laboral
                    profesor.horasInvestigacionSemanal = horasInvestigacionSemanal;
                    profesor.horasProyectosInstSemanal = horasProyectosInstSemanal;
                    profesor.horasProyectosExtSemanal = horasProyectosExtSemanal;
                    profesor.horasMaterialDidacticoSemanal = horasMaterialDidacticoSemanal;
                    profesor.horasCapacitacionSemestral = horasCapacitacionSemestral;
                    // profesor.horasObjetivoSemanal = horasObjetivoSemanal; // Opcional
                    mostrarNotificacion('Éxito', 'Profesor actualizado correctamente.', 'success');
                }
            } else { // Añadir
                const nuevoId = `PROF-${Date.now()}-${Math.random().toString(16).slice(2, 8)}`; // ID único robusto
                estado.profesores.push({
                    id: nuevoId,
                    codigo: codigo,
                    nombre: nombre,
                    especialidad: especialidad,
                    diasDisponibles: diasDisponibles,
                    materiasQueDicta: materiasQueDicta,
                    // Añadir carga laboral
                    horasInvestigacionSemanal: horasInvestigacionSemanal,
                    horasProyectosInstSemanal: horasProyectosInstSemanal,
                    horasProyectosExtSemanal: horasProyectosExtSemanal,
                    horasMaterialDidacticoSemanal: horasMaterialDidacticoSemanal,
                    horasCapacitacionSemestral: horasCapacitacionSemestral,
                    // horasObjetivoSemanal: horasObjetivoSemanal // Opcional
                });
                mostrarNotificacion('Éxito', 'Profesor añadido correctamente.', 'success');
            }

            cerrarModal('modalProfesor');
            renderizarProfesores(); // Re-renderizar para actualizar tabla y resumen
            guardarDatosLocalmente();
            actualizarInterfaz(); // Actualizar selectores dependientes
        }

        // Eliminar Profesor
        function eliminarProfesor(id) {
            if (confirm(`¿Está seguro de que desea eliminar al profesor con ID ${id}? Esto podría afectar materias y horarios asignados.`)) {
                estado.profesores = estado.profesores.filter(p => p.id !== id);
                // Limpiar horarios (más complejo, requiere iterar)
                Object.keys(estado.horarios).forEach(sem => {
                    Object.keys(estado.horarios[sem]).forEach(dia => {
                        Object.keys(estado.horarios[sem][dia]).forEach(hora => {
                            if (estado.horarios[sem][dia][hora]?.profesorId === id) {
                                // Opcional: ¿Eliminar la sesión o solo quitar el profesor?
                                // Por ahora, eliminamos la sesión para evitar inconsistencias
                                delete estado.horarios[sem][dia][hora];
                            }
                        });
                    });
                });

                renderizarProfesores();
                generarHorariosVisualizacion(); // Regenerar vistas
                actualizarHorarioVisible(); // Actualizar tabla visible
                guardarDatosLocalmente();
                actualizarInterfaz();
                mostrarNotificacion('Éxito', 'Profesor eliminado.', 'success');
            }
        }

        // Mostrar modal Materia (Añadir o Editar)
        function mostrarModalMateria(materiaId = null) {
            const modal = document.getElementById('modalMateria');
            const titulo = document.getElementById('modalMateriaTitulo');
            const codigoInput = document.getElementById('materiaCodigo');
            const nombreInput = document.getElementById('materiaNombre');
            const semestreSelect = document.getElementById('materiaSemestre');
            const horasInput = document.getElementById('materiaHoras'); // Representa bloques
            const tipoAulaSelect = document.getElementById('materiaTipoAula');
            const editIdInput = document.getElementById('materiaEditId');

            // Asegurarse de que los selectores estén poblados
            actualizarSelectorSemestres();

            if (materiaId) { // Editar
                const materia = estado.materias.find(m => m.id === materiaId);
                if (!materia) return;
                titulo.textContent = 'Editar Materia';
                codigoInput.value = materia.codigo;
                nombreInput.value = materia.nombre;
                semestreSelect.value = materia.semestre;
                horasInput.value = materia.horasSemana; // Bloques
                tipoAulaSelect.value = materia.tipoAula;
                editIdInput.value = materiaId;
                estado.editandoId = materiaId;
            } else { // Añadir
                titulo.textContent = 'Añadir Nueva Materia';
                codigoInput.value = '';
                nombreInput.value = '';
                semestreSelect.value = '1'; // Valor por defecto
                horasInput.value = '2'; // Valor por defecto (bloques)
                tipoAulaSelect.value = 'normal'; // Valor por defecto
                editIdInput.value = '';
                estado.editandoId = null;
            }
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        // Guardar Materia
        function guardarMateria() {
            const id = estado.editandoId;
            const codigo = document.getElementById('materiaCodigo').value.trim();
            const nombre = document.getElementById('materiaNombre').value.trim();
            const semestre = parseInt(document.getElementById('materiaSemestre').value);
            const horasSemana = parseInt(document.getElementById('materiaHoras').value); // Bloques
            const tipoAula = document.getElementById('materiaTipoAula').value;

            if (!codigo || !nombre || isNaN(semestre) || isNaN(horasSemana)) {
                mostrarNotificacion('Error', 'Código, nombre, semestre y bloques son obligatorios y deben ser válidos.', 'error');
                return;
            }

             // Validar que el código no exista ya
            const codigoExiste = estado.materias.some(m => m.codigo === codigo && m.id !== id);
            if (codigoExiste) {
                 mostrarNotificacion('Error', `El código '${codigo}' ya está en uso por otra materia.`, 'error');
                 return;
            }

            if (id) { // Editar
                const materia = estado.materias.find(m => m.id === id);
                if (materia) {
                    materia.codigo = codigo;
                    materia.nombre = nombre;
                    materia.semestre = semestre;
                    materia.horasSemana = horasSemana; // Guardar bloques
                    materia.tipoAula = tipoAula;
                    mostrarNotificacion('Éxito', 'Materia actualizada correctamente.', 'success');
                }
            } else { // Añadir
                 const nuevoId = `MAT-${Date.now()}-${Math.random().toString(16).slice(2, 8)}`;
                estado.materias.push({
                    id: nuevoId, codigo, nombre, semestre, horasSemana, tipoAula // Guardar bloques
                });
                mostrarNotificacion('Éxito', 'Materia añadida correctamente.', 'success');
            }

            cerrarModal('modalMateria');
            renderizarMaterias();
            renderizarProfesores(); // La carga puede cambiar si cambian horas de materia
            guardarDatosLocalmente();
            actualizarInterfaz();
        }

        // Eliminar Materia
        function eliminarMateria(id) {
            if (confirm(`¿Está seguro de que desea eliminar la materia con ID ${id}? Esto la quitará de los horarios y de las asignaciones a profesores.`)) {
                estado.materias = estado.materias.filter(m => m.id !== id);
                // Limpiar horarios que usen esta materia
                Object.keys(estado.horarios).forEach(sem => {
                    Object.keys(estado.horarios[sem]).forEach(dia => {
                        Object.keys(estado.horarios[sem][dia]).forEach(hora => {
                            if (estado.horarios[sem][dia][hora]?.codigo === id) { // Comparar con código/id
                                delete estado.horarios[sem][dia][hora];
                            }
                        });
                    });
                });
                // Limpiar asignaciones en profesores
                estado.profesores.forEach(p => {
                    if (p.materiasQueDicta) {
                        p.materiasQueDicta = p.materiasQueDicta.filter(matId => matId !== id);
                    }
                });

                renderizarMaterias();
                renderizarProfesores(); // Actualizar carga y lista de materias por profesor
                generarHorariosVisualizacion(); // Regenerar vistas
                actualizarHorarioVisible(); // Actualizar tabla visible
                guardarDatosLocalmente();
                actualizarInterfaz();
                mostrarNotificacion('Éxito', 'Materia eliminada.', 'success');
            }
        }

        // Mostrar modal Aula (Añadir o Editar)
        function mostrarModalAula(aulaId = null) {
            const modal = document.getElementById('modalAula');
            const titulo = document.getElementById('modalAulaTitulo');
            const codigoInput = document.getElementById('aulaCodigo');
            const nombreInput = document.getElementById('aulaNombre');
            const tipoSelect = document.getElementById('aulaTipo');
            const capacidadInput = document.getElementById('aulaCapacidad');
            const ubicacionInput = document.getElementById('aulaUbicacion');
            const editIdInput = document.getElementById('aulaEditId');

            if (aulaId) { // Editar
                const aula = estado.aulas.find(a => a.id === aulaId);
                if (!aula) return;
                titulo.textContent = 'Editar Aula';
                codigoInput.value = aula.codigo;
                nombreInput.value = aula.nombre;
                tipoSelect.value = aula.tipo;
                capacidadInput.value = aula.capacidad;
                ubicacionInput.value = aula.ubicacion || '';
                editIdInput.value = aulaId;
                estado.editandoId = aulaId;
            } else { // Añadir
                titulo.textContent = 'Añadir Nueva Aula';
                codigoInput.value = '';
                nombreInput.value = '';
                tipoSelect.value = 'normal';
                capacidadInput.value = '30';
                ubicacionInput.value = '';
                editIdInput.value = '';
                estado.editandoId = null;
            }
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        // Guardar Aula
        function guardarAula() {
            const id = estado.editandoId;
            const codigo = document.getElementById('aulaCodigo').value.trim();
            const nombre = document.getElementById('aulaNombre').value.trim();
            const tipo = document.getElementById('aulaTipo').value;
            const capacidad = parseInt(document.getElementById('aulaCapacidad').value);
            const ubicacion = document.getElementById('aulaUbicacion').value.trim();

            if (!codigo || !nombre || isNaN(capacidad) || capacidad <= 0) {
                mostrarNotificacion('Error', 'Código, nombre y capacidad válida son obligatorios.', 'error');
                return;
            }

             // Validar que el código no exista ya
            const codigoExiste = estado.aulas.some(a => a.codigo === codigo && a.id !== id);
            if (codigoExiste) {
                 mostrarNotificacion('Error', `El código '${codigo}' ya está en uso por otra aula.`, 'error');
                 return;
            }

            if (id) { // Editar
                const aula = estado.aulas.find(a => a.id === id);
                if (aula) {
                    aula.codigo = codigo;
                    aula.nombre = nombre;
                    aula.tipo = tipo;
                    aula.capacidad = capacidad;
                    aula.ubicacion = ubicacion;
                    mostrarNotificacion('Éxito', 'Aula actualizada correctamente.', 'success');
                }
            } else { // Añadir
                 const nuevoId = `AULA-${Date.now()}-${Math.random().toString(16).slice(2, 8)}`;
                estado.aulas.push({
                    id: nuevoId, codigo, nombre, tipo, capacidad, ubicacion
                });
                mostrarNotificacion('Éxito', 'Aula añadida correctamente.', 'success');
            }

            cerrarModal('modalAula');
            renderizarAulas();
            guardarDatosLocalmente();
            actualizarInterfaz();
        }

        // Eliminar Aula
        function eliminarAula(id) {
             if (confirm(`¿Está seguro de que desea eliminar el aula con ID ${id}? Esto podría afectar horarios asignados.`)) {
                estado.aulas = estado.aulas.filter(a => a.id !== id);
                 // Opcional: Limpiar referencias en horarios
                 Object.keys(estado.horarios).forEach(sem => {
                    Object.keys(estado.horarios[sem]).forEach(dia => {
                        Object.keys(estado.horarios[sem][dia]).forEach(hora => {
                            if (estado.horarios[sem][dia][hora]?.aulaId === id) {
                                // Opcional: ¿Eliminar la sesión o solo quitar el aula?
                                // Por ahora, eliminamos la sesión para evitar inconsistencias
                                delete estado.horarios[sem][dia][hora];
                            }
                        });
                    });
                });

                renderizarAulas();
                generarHorariosVisualizacion(); // Regenerar vistas
                actualizarHorarioVisible(); // Actualizar tabla visible
                guardarDatosLocalmente();
                actualizarInterfaz();
                mostrarNotificacion('Éxito', 'Aula eliminada.', 'success');
            }
        }

        // --- IMPORTACIÓN / EXPORTACIÓN / EJEMPLO ---

        // Cargar datos desde archivo Excel
        function cargarDatosDesdeExcel() {
            const fileInput = document.getElementById('excelFileInput');
            if (fileInput.files.length === 0) {
                mostrarNotificacion('Error', 'Por favor seleccione un archivo Excel.', 'error');
                return;
            }
            const file = fileInput.files[0];
            mostrarCargando(true);

            const reader = new FileReader();
            reader.onload = function (e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    procesarDatosExcel(workbook); // Procesar datos
                    guardarDatosLocalmente();
                    renderizarTodo();
                    actualizarInterfaz();
                    actualizarEstadoBotones(); // Habilitar botones si hay datos
                    mostrarNotificacion('Éxito', 'Datos cargados correctamente desde Excel.', 'success');
                } catch (error) {
                    console.error('Error al procesar Excel:', error);
                    mostrarNotificacion('Error', `No se pudo procesar el archivo: ${error.message}`, 'error');
                } finally {
                    mostrarCargando(false);
                    fileInput.value = ''; // Limpiar input para permitir recargar el mismo archivo
                }
            };
            reader.onerror = function() {
                mostrarCargando(false);
                mostrarNotificacion('Error', 'Error al leer el archivo.', 'error');
            };
            reader.readAsArrayBuffer(file);
        }

        // Procesar datos del workbook de Excel
        function procesarDatosExcel(workbook) {
            console.log("Procesando Excel:", workbook.SheetNames);
            estado.profesores = []; estado.materias = []; estado.aulas = []; estado.restricciones = []; // Limpiar datos existentes

            const sheetNames = workbook.SheetNames;

            // --- HOJA 1: PROFESORES ---
            if (sheetNames.length >= 1 && workbook.Sheets[sheetNames[0]]) {
                const ws = workbook.Sheets[sheetNames[0]];
                const data = XLSX.utils.sheet_to_json(ws, { header: 1 });
                console.log("Datos Profesores:", data);
                if (data && data.length > 1) {
                    for (let i = 1; i < data.length; i++) {
                        const row = data[i];
                        if (row && row.length > 0 && row[0]) { // Fila válida con al menos código
                             const id = `PROF-${String(row[0]).trim()}-${i}`; // ID único basado en código y fila
                             // Disponibilidad por defecto (L-V Mañana/Tarde)
                             const defaultDisp = {};
                             ["Lunes", "Martes", "Miércoles", "Jueves", "Viernes", "Sábado"].forEach(d => {
                                 defaultDisp[d] = { mañana: (d !== 'Sábado'), tarde: (d !== 'Sábado') };
                             });
                            estado.profesores.push({
                                id: id,
                                codigo: String(row[0]).trim(),
                                nombre: String(row[1] || "Sin nombre").trim(),
                                especialidad: String(row[2] || "No especificada").trim(),
                                diasDisponibles: defaultDisp, // Usar disponibilidad por defecto
                                materiasQueDicta: [], // Inicializar vacío, se llena en modal
                                // Carga laboral por defecto (o leer de más columnas si existen)
                                horasInvestigacionSemanal: parseFloat(row[3]) || 0,
                                horasProyectosInstSemanal: parseFloat(row[4]) || 0,
                                horasProyectosExtSemanal: parseFloat(row[5]) || 0,
                                horasMaterialDidacticoSemanal: parseFloat(row[6]) || 0,
                                horasCapacitacionSemestral: parseFloat(row[7]) || 0,
                                // horasObjetivoSemanal: parseFloat(row[8]) || null
                            });
                        }
                    }
                }
            } else { console.warn("Hoja de Profesores no encontrada o vacía."); }

            // --- HOJA 2: MATERIAS ---
            if (sheetNames.length >= 2 && workbook.Sheets[sheetNames[1]]) {
                const ws = workbook.Sheets[sheetNames[1]];
                const data = XLSX.utils.sheet_to_json(ws, { header: 1 });
                 console.log("Datos Materias:", data);
                if (data && data.length > 1) {
                    for (let i = 1; i < data.length; i++) {
                        const row = data[i];
                         if (row && row.length > 0 && row[0]) {
                             const id = `MAT-${String(row[0]).trim()}-${i}`;
                            estado.materias.push({
                                id: id,
                                codigo: String(row[0]).trim(),
                                nombre: String(row[1] || "Sin nombre").trim(),
                                semestre: parseInt(row[2]) || 1,
                                horasSemana: parseInt(row[3]) || 2, // Interpretar como bloques
                                tipoAula: String(row[4] || "normal").toLowerCase().trim()
                            });
                        }
                    }
                }
            } else { console.warn("Hoja de Materias no encontrada o vacía."); }

            // --- HOJA 3: AULAS ---
            if (sheetNames.length >= 3 && workbook.Sheets[sheetNames[2]]) {
                const ws = workbook.Sheets[sheetNames[2]];
                const data = XLSX.utils.sheet_to_json(ws, { header: 1 });
                 console.log("Datos Aulas:", data);
                if (data && data.length > 1) {
                    for (let i = 1; i < data.length; i++) {
                        const row = data[i];
                         if (row && row.length > 0 && row[0]) {
                             const id = `AULA-${String(row[0]).trim()}-${i}`;
                            estado.aulas.push({
                                id: id,
                                codigo: String(row[0]).trim(),
                                nombre: String(row[1] || "Sin nombre").trim(),
                                tipo: String(row[2] || "normal").toLowerCase().trim(),
                                capacidad: parseInt(row[3]) || 30,
                                ubicacion: String(row[4] || "").trim()
                            });
                        }
                    }
                }
            } else { console.warn("Hoja de Aulas no encontrada o vacía."); }

             // --- HOJA 4: RESTRICCIONES FIJAS (opcional) ---
            if (sheetNames.length >= 4 && workbook.Sheets[sheetNames[3]]) {
                const ws = workbook.Sheets[sheetNames[3]];
                const data = XLSX.utils.sheet_to_json(ws, { header: 1 });
                 console.log("Datos Restricciones Fijas:", data);
                if (data && data.length > 1) {
                    for (let i = 1; i < data.length; i++) {
                        const row = data[i];
                        // Necesita al menos Profesor, Materia, Aula, Dia, Hora
                        if (row && row.length >= 5 && row[0] && row[1] && row[2] && row[3] && row[4]) {
                            const profCodigo = String(row[0]).trim();
                            const matCodigo = String(row[1]).trim();
                            const aulaCodigo = String(row[2]).trim();
                            const dia = String(row[3]).trim(); // Asumiendo formato de día como "Lunes", "Martes", etc.
                            const hora = String(row[4]).trim(); // Asumiendo formato de hora como "HH:MM"

                            // Buscar IDs correspondientes
                            const profesor = estado.profesores.find(p => p.codigo === profCodigo);
                            const materia = estado.materias.find(m => m.codigo === matCodigo);
                            const aula = estado.aulas.find(a => a.codigo === aulaCodigo);

                            // Validar que el profesor pueda dictar la materia (requiere que se asignen materias a profesores ANTES de importar restricciones)
                            // NOTA: La importación actual no asigna materias a profesores desde Excel. Se debe hacer manualmente después.
                            // Por ahora, omitimos esta validación aquí, pero se hará al intentar fijar.
                            // const profesorPuedeDictar = profesor?.materiasQueDicta?.includes(materia?.id);

                            if (profesor && materia && aula /*&& profesorPuedeDictar*/ && obtenerDiasHabiles().includes(dia) && calcularHorasPorDia().includes(hora)) {
                                estado.restricciones.push({
                                    tipo: 'horarioFijo',
                                    profesorId: profesor.id,
                                    materiaId: materia.id,
                                    aulaId: aula.id,
                                    semestre: materia.semestre, // Tomar semestre de la materia
                                    dia: dia,
                                    hora: hora,
                                });
                            } else {
                                let razon = "Datos no encontrados o inválidos";
                                // if (profesor && materia && !profesorPuedeDictar) {
                                //     razon = `Profesor ${profCodigo} no asignado para dictar ${matCodigo}`;
                                // }
                                console.warn(`Restricción fija inválida en fila ${i+1} (${razon}):`, row);
                            }
                        }
                    }
                }
                 console.log("Restricciones Fijas procesadas:", estado.restricciones.filter(r => r.tipo === 'horarioFijo'));
            } else { console.log("Hoja de Restricciones Fijas no encontrada (opcional)."); }
        }

        // Cargar datos de ejemplo
        function cargarDatosEjemplo() {
            estado.profesores = [
                { id: "PROF1", codigo: "P001", nombre: "Dr. Juan Pérez", especialidad: "Informática", materiasQueDicta: ["MAT1", "MAT5", "MAT7"], diasDisponibles: {"Lunes":{mañana:true,tarde:true},"Martes":{mañana:true,tarde:true},"Miércoles":{mañana:true,tarde:true},"Jueves":{mañana:true,tarde:true},"Viernes":{mañana:true,tarde:true},"Sábado":{mañana:false,tarde:false}}, horasInvestigacionSemanal: 4, horasProyectosInstSemanal: 2, horasMaterialDidacticoSemanal: 1, horasCapacitacionSemestral: 16 },
                { id: "PROF2", codigo: "P002", nombre: "Dra. María López", especialidad: "Matemáticas", materiasQueDicta: ["MAT2", "MAT6", "MAT8"], diasDisponibles: {"Lunes":{mañana:true,tarde:false},"Martes":{mañana:true,tarde:false},"Miércoles":{mañana:true,tarde:false},"Jueves":{mañana:true,tarde:false},"Viernes":{mañana:true,tarde:false},"Sábado":{mañana:false,tarde:false}}, horasInvestigacionSemanal: 6, horasProyectosExtSemanal: 3, horasCapacitacionSemestral: 8 },
                { id: "PROF3", codigo: "P003", nombre: "Ing. Carlos R.", especialidad: "Electrónica", materiasQueDicta: ["MAT3"], diasDisponibles: {"Lunes":{mañana:false,tarde:true},"Martes":{mañana:false,tarde:true},"Miércoles":{mañana:false,tarde:true},"Jueves":{mañana:false,tarde:true},"Viernes":{mañana:false,tarde:true},"Sábado":{mañana:false,tarde:false}}, horasProyectosInstSemanal: 4, horasMaterialDidacticoSemanal: 2 },
                { id: "PROF4", codigo: "P004", nombre: "Lic. Ana Martínez", especialidad: "Inglés", materiasQueDicta: ["MAT4"], diasDisponibles: {"Lunes":{mañana:true,tarde:true},"Martes":{mañana:true,tarde:true},"Miércoles":{mañana:true,tarde:true},"Jueves":{mañana:true,tarde:true},"Viernes":{mañana:true,tarde:true},"Sábado":{mañana:false,tarde:false}}, horasMaterialDidacticoSemanal: 3, horasCapacitacionSemestral: 12 }
            ];
            estado.materias = [
                { id: "MAT1", codigo: "INF-101", nombre: "Programación I", semestre: 1, horasSemana: 4, tipoAula: "informatica" }, // 4 bloques
                { id: "MAT2", codigo: "MAT-101", nombre: "Matemáticas Disc.", semestre: 1, horasSemana: 4, tipoAula: "normal" }, // 4 bloques
                { id: "MAT3", codigo: "ARQ-201", nombre: "Arquitectura Comp.", semestre: 2, horasSemana: 3, tipoAula: "laboratorio" }, // 3 bloques
                { id: "MAT4", codigo: "ING-101", nombre: "Inglés Técnico I", semestre: 1, horasSemana: 2, tipoAula: "normal" }, // 2 bloques
                { id: "MAT5", codigo: "INF-201", nombre: "Programación II", semestre: 2, horasSemana: 4, tipoAula: "informatica" }, // 4 bloques
                { id: "MAT6", codigo: "MAT-201", nombre: "Cálculo Diferencial", semestre: 2, horasSemana: 4, tipoAula: "normal" }, // 4 bloques
                { id: "MAT7", codigo: "INF-301", nombre: "Base de Datos", semestre: 3, horasSemana: 4, tipoAula: "informatica" }, // 4 bloques
                { id: "MAT8", codigo: "EST-301", nombre: "Estadística", semestre: 3, horasSemana: 3, tipoAula: "normal" } // 3 bloques
            ];
            estado.aulas = [
                { id: "AULA1", codigo: "A101", nombre: "Salón 101", tipo: "normal", capacidad: 40, ubicacion: "Edificio A" },
                { id: "AULA2", codigo: "A102", nombre: "Salón 102", tipo: "normal", capacidad: 35, ubicacion: "Edificio A" },
                { id: "AULA3", codigo: "B201-L", nombre: "Lab Info 1", tipo: "informatica", capacidad: 30, ubicacion: "Edificio B" },
                { id: "AULA4", codigo: "B101-L", nombre: "Lab Electro", tipo: "laboratorio", capacidad: 25, ubicacion: "Edificio B" },
                { id: "AULA5", codigo: "B202-L", nombre: "Lab Info 2", tipo: "informatica", capacidad: 30, ubicacion: "Edificio B" }
            ];
             estado.restricciones = [ // Ejemplo de restricción fija
                 { tipo: 'horarioFijo', profesorId: 'PROF4', materiaId: 'MAT4', aulaId: 'AULA1', semestre: 1, dia: 'Lunes', hora: '10:00' }
             ];
            estado.configuracion = {
                periodoAcademico: "semestral", cantidadSemestres: 3, horaInicio: "06:00", horaFin: "18:00", duracionBloque: 60,
                diasDisponibles: ["Lunes", "Martes", "Miércoles", "Jueves", "Viernes"],
                asesoriasNormalesConfig: { habilitado: true, duracionMinutos: 60, vecesPorSemana: 2 },
                asesoriasEvaluacionConfig: { habilitado: true, duracionMinutos: 120, vecesPorSemana: 1 },
                // Campos obsoletos (se mantienen por compatibilidad pero no se usan)
                habilitarAsesorias: true,
                duracionAsesoria: 30
            };
            estado.horarios = {}; // Limpiar horarios previos
            estado.horariosAsesorias = {}; // Limpiar asesorías previas

            mostrarNotificacion('Éxito', 'Datos de ejemplo cargados.', 'success');
            renderizarTodo();
            actualizarInterfaz();
            actualizarEstadoBotones();
            guardarDatosLocalmente();
        }

        // Exportar horarios (controlador)
        function exportarHorarios() {
            const formato = document.getElementById('formatoExportacion').value;
            const tipoVista = document.getElementById('filtroVistaHorario').value;
            const elementoId = document.getElementById('elementoSeleccionado').value;
            const pdfPageSize = document.getElementById('pdfPageSize').value;
            const pdfOrientation = document.getElementById('pdfOrientation').value;

            // Si es vista de asesoría, no exportar por ahora (o implementar exportación específica)
            if (tipoVista === 'asesoria') {
                mostrarNotificacion('Info', 'La exportación de la vista de asesorías no está implementada.', 'info');
                return;
            }

            const datosParaExportar = obtenerDatosParaVista(tipoVista, elementoId);

            if (!datosParaExportar || Object.keys(datosParaExportar.horario).length === 0) {
                mostrarNotificacion('Error', 'No hay horarios generados o visibles para exportar.', 'error');
                return;
            }

            try {
                if (formato === 'excel') exportarHorariosExcel();
                else if (formato === 'pdf') exportarHorariosPDF();
            } catch (error) {
                mostrarNotificacion('Error', `Error al exportar: ${error.message}`, 'error');
            } finally {
                // Opcional: cerrar el menú si no se usa hover
            }
        }

        // Exportar a Excel
        function exportarHorariosExcel() {
            const tipoVista = document.getElementById('filtroVistaHorario').value;
            const elementoId = document.getElementById('elementoSeleccionado').value;
            const { horario: datosHorario, titulo } = obtenerDatosParaVista(tipoVista, elementoId);

            if (!datosHorario || Object.keys(datosHorario).length === 0) {
                 mostrarNotificacion('Error', 'No hay datos en la vista actual para exportar a Excel.', 'error');
                 return;
            }

            mostrarCargando(true);
            setTimeout(() => { // Dar tiempo a que se muestre el loading
                try {
                    const wb = XLSX.utils.book_new();
                    const diasHabiles = obtenerDiasHabiles();
                    const horasPorDia = calcularHorasPorDia();
                    const data = [];

                    // Añadir título como primera fila (fusionada)
                    const titleRow = [titulo];
                    data.push(titleRow);

                    // Cabecera de la tabla
                    const header = ['Hora', ...diasHabiles];
                    data.push(header);

                    // Datos del horario
                    horasPorDia.forEach(hora => {
                        const row = [hora];
                        diasHabiles.forEach(dia => {
                            const sesion = datosHorario[dia]?.[hora];
                            // Formato de celda: Materia (Profesor) [Aula] {Semestre}
                            let cellText = '';
                            if (sesion) {
                                cellText = `${sesion.materia}\n(${sesion.profesor})\n[${sesion.aula}]`;
                                if (sesion.semestre && tipoVista !== 'semestre') { // Añadir semestre si no es vista por semestre
                                    cellText += `\n{S${sesion.semestre}}`;
                                }
                            }
                            row.push(cellText);
                        });
                        data.push(row);
                    });

                    const ws = XLSX.utils.aoa_to_sheet(data);

                    // Fusionar celdas para el título
                    ws['!merges'] = [{ s: { r: 0, c: 0 }, e: { r: 0, c: diasHabiles.length } }];

                    // Estilo básico para saltos de línea y ajuste
                    const cellStyle = { alignment: { wrapText: true, vertical: 'top' } };
                    Object.keys(ws).forEach(cellRef => {
                        if (cellRef[0] === '!') return; // Saltar metadatos
                        ws[cellRef].s = cellStyle;
                    });


                    const cols = header.map((_, i) => ({ wch: i === 0 ? 8 : 25 })); // Ajustar ancho
                    ws['!cols'] = cols;

                    XLSX.utils.book_append_sheet(wb, ws, 'Horario'); // Nombre de la hoja
                    XLSX.writeFile(wb, `Horario_${titulo.replace(/[^a-zA-Z0-9]/g, '_')}_${new Date().toISOString().slice(0,10)}.xlsx`);
                    mostrarNotificacion('Éxito', 'Horarios exportados a Excel.', 'success');
                } catch (error) {
                    console.error('Error exportando a Excel:', error);
                    mostrarNotificacion('Error', `No se pudo exportar a Excel: ${error.message}`, 'error');
                } finally {
                    mostrarCargando(false);
                }
            }, 100); // Pequeño delay
        }

        // Exportar a PDF
        function exportarHorariosPDF() {
            const tipoVista = document.getElementById('filtroVistaHorario').value;
            const elementoId = document.getElementById('elementoSeleccionado').value;
            const { horario: datosHorario, titulo } = obtenerDatosParaVista(tipoVista, elementoId);
            const pageSize = document.getElementById('pdfPageSize').value; // letter, legal, a4
            const orientation = document.getElementById('pdfOrientation').value; // landscape, portrait

            if (!datosHorario || Object.keys(datosHorario).length === 0) {
                 mostrarNotificacion('Error', 'No hay datos en la vista actual para exportar a PDF.', 'error');
                 return;
            }

            mostrarCargando(true);
            setTimeout(() => {
                try {
                    const { jsPDF } = window.jspdf;
                    // Definir tamaño Oficio (aproximado, puede variar)
                    const oficioWidthMM = 216;
                    const oficioHeightMM = 330; // Ajustado para 'legal' típico
                    const format = pageSize === 'legal' ? [oficioWidthMM, oficioHeightMM] : pageSize; // Usar dimensiones para oficio/legal

                    const doc = new jsPDF({ orientation: orientation, unit: 'mm', format: format });
                    const pageWidth = doc.internal.pageSize.getWidth();
                    const pageHeight = doc.internal.pageSize.getHeight();
                    const margin = 10;
                    const usableWidth = pageWidth - 2 * margin;
                    let y = margin;

                    doc.setFontSize(16);
                    doc.text(titulo, pageWidth / 2, y, { align: 'center' });
                    y += 8;
                    doc.setFontSize(10);
                    doc.text(`Generado: ${new Date().toLocaleString()}`, pageWidth - margin, y, { align: 'right' });
                    y += 10;

                    const diasHabiles = obtenerDiasHabiles();
                    const horasPorDia = calcularHorasPorDia();
                    const numCols = diasHabiles.length + 1;
                    const colWidth = usableWidth / numCols;
                    const headerHeight = orientation === 'landscape' ? 6 : 7; // Más compacto en horizontal
                    const rowHeight = orientation === 'landscape' ? 9 : 11; // Altura para ~3 líneas pequeñas

                    // --- Cabecera de la tabla ---
                    doc.setFontSize(orientation === 'landscape' ? 7 : 8);
                    doc.setFont(undefined, 'bold');
                    doc.setFillColor(230, 230, 230);
                    doc.rect(margin, y, usableWidth, headerHeight, 'F');
                    doc.rect(margin, y, colWidth, headerHeight, 'S'); // Celda Hora
                    doc.text('Hora', margin + colWidth / 2, y + headerHeight / 2 + (orientation === 'landscape' ? 1.5 : 2), { align: 'center' });
                    diasHabiles.forEach((dia, i) => {
                        const x = margin + colWidth * (i + 1);
                        doc.rect(x, y, colWidth, headerHeight, 'S');
                        doc.text(dia, x + colWidth / 2, y + headerHeight / 2 + (orientation === 'landscape' ? 1.5 : 2), { align: 'center' });
                    });
                    y += headerHeight;
                    doc.setFont(undefined, 'normal');
                    // --- Fin Cabecera ---

                    // --- Filas de datos ---
                    horasPorDia.forEach(hora => {
                        if (y + rowHeight > pageHeight - margin) { // Salto de página si no cabe
                            doc.addPage();
                            y = margin;
                            // Repetir cabecera en nueva página
                            doc.setFontSize(orientation === 'landscape' ? 7 : 8); doc.setFont(undefined, 'bold'); doc.setFillColor(230, 230, 230);
                            doc.rect(margin, y, usableWidth, headerHeight, 'F');
                            doc.rect(margin, y, colWidth, headerHeight, 'S');
                            doc.text('Hora', margin + colWidth / 2, y + headerHeight / 2 + (orientation === 'landscape' ? 1.5 : 2), { align: 'center' });
                            diasHabiles.forEach((dia, i) => { const x = margin + colWidth * (i + 1); doc.rect(x, y, colWidth, headerHeight, 'S'); doc.text(dia, x + colWidth / 2, y + headerHeight / 2 + (orientation === 'landscape' ? 1.5 : 2), { align: 'center' }); });
                            y += headerHeight; doc.setFont(undefined, 'normal');
                        }

                        // Celda de Hora
                        doc.setFillColor(245, 245, 245);
                        doc.rect(margin, y, colWidth, rowHeight, 'FD'); // Con borde
                        doc.setFontSize(orientation === 'landscape' ? 7 : 8); doc.setFont(undefined, 'bold');
                        doc.text(hora, margin + colWidth / 2, y + rowHeight / 2 + (orientation === 'landscape' ? 1 : 1.5), { align: 'center' });
                        doc.setFont(undefined, 'normal');

                        // Celdas de Sesiones
                        diasHabiles.forEach((dia, i) => {
                            const x = margin + colWidth * (i + 1);
                            doc.rect(x, y, colWidth, rowHeight, 'S'); // Solo borde
                            const sesion = datosHorario[dia]?.[hora];
                            if (sesion) {
                                doc.setFontSize(orientation === 'landscape' ? 5 : 6); // Tamaño muy pequeño
                                let textLines = [ sesion.materia, `(${sesion.profesor})`, `[${sesion.aula}]` ];
                                if (sesion.semestre && tipoVista !== 'semestre') textLines.push(`{S${sesion.semestre}}`);

                                if (sesion.fijado) doc.setTextColor(139, 92, 246); // Morado
                                doc.text(textLines, x + 1, y + (orientation === 'landscape' ? 2 : 2.5), { maxWidth: colWidth - 2 });
                                if (sesion.fijado) doc.setTextColor(0, 0, 0); // Reset color
                            }
                        });
                        y += rowHeight;
                    });

                    // Numeración de páginas
                    const totalPages = doc.internal.getNumberOfPages();
                    for (let i = 1; i <= totalPages; i++) {
                        doc.setPage(i);
                        doc.setFontSize(8);
                        doc.text(`Página ${i} de ${totalPages}`, pageWidth - margin, pageHeight - 5, { align: 'right' });
                    }

                    doc.save(`Horario_${titulo.replace(/[^a-zA-Z0-9]/g, '_')}_${new Date().toISOString().slice(0,10)}.pdf`);
                    mostrarNotificacion('Éxito', 'Horarios exportados a PDF.', 'success');
                } catch (error) {
                    console.error('Error exportando a PDF:', error);
                    mostrarNotificacion('Error', `No se pudo exportar a PDF: ${error.message}`, 'error');
                } finally {
                    mostrarCargando(false);
                }
            }, 100);
        }

        // --- GENERACIÓN Y OPTIMIZACIÓN DE HORARIOS ---

        // Función principal para generar horarios
        function generarHorarios() {
            if (estado.profesores.length === 0 || estado.materias.length === 0 || estado.aulas.length === 0) {
                mostrarNotificacion('Error', 'Se necesitan profesores, materias y aulas para generar horarios.', 'error');
                return;
            }
            mostrarCargando(true);
            setTimeout(() => { // Delay para UI
                try {
                    console.log("Iniciando generación de horarios...");
                    // 1. Inicializar estructura de horarios
                    estado.horarios = {};
                    const cantidadSemestres = parseInt(estado.configuracion.cantidadSemestres) || 4;
                    const diasHabiles = obtenerDiasHabiles();
                    const horasPorDia = calcularHorasPorDia();
                    for (let sem = 1; sem <= cantidadSemestres; sem++) {
                        estado.horarios[sem] = {};
                        diasHabiles.forEach(dia => {
                            estado.horarios[sem][dia] = {};
                            // No inicializar horas aquí, se crean al asignar
                        });
                    }
                    console.log("Estructura inicial creada.");

                    // 2. Aplicar restricciones fijas PRIMERO
                    aplicarRestriccionesFijas();
                    console.log("Restricciones fijas aplicadas.");

                    // 3. Asignar materias restantes
                    const materiasNoAsignadas = [];
                    for (let sem = 1; sem <= cantidadSemestres; sem++) {
                        const materiasSemestre = estado.materias.filter(m => m.semestre === sem);
                        console.log(`Asignando ${materiasSemestre.length} materias para Semestre ${sem}`);
                        const resultadoAsignacion = asignarMateriasASemestre(materiasSemestre, sem, diasHabiles, horasPorDia);
                        materiasNoAsignadas.push(...resultadoAsignacion.noAsignadas);
                    }

                    // 4. Post-procesamiento y UI
                    generarHorariosVisualizacion(); // Generar vistas para todas las visualizaciones
                    actualizarHorarioVisible();
                    actualizarEstadisticasHorario();
                    document.getElementById('mensajeNoHorario').classList.add('hidden');
                    document.getElementById('tablaHorario').classList.remove('hidden');
                    guardarDatosLocalmente();
                    actualizarEstadoBotones(); // Habilitar optimizar/editar
                    renderizarProfesores(); // Actualizar resumen de carga detallado

                    // 5. Informe
                    if (materiasNoAsignadas.length > 0) {
                         mostrarInformeGeneracion({ estado: 'parcial', noAsignadas: materiasNoAsignadas });
                         mostrarNotificacion('Advertencia', `${materiasNoAsignadas.length} materias no pudieron ser asignadas completamente. Ver informe.`, 'error');
                    } else {
                         mostrarInformeGeneracion({ estado: 'completo' });
                         mostrarNotificacion('Éxito', 'Horarios generados correctamente.', 'success');
                    }
                     console.log("Generación completada.");

                } catch (error) {
                    console.error("Error generando horarios:", error);
                    mostrarNotificacion('Error', `Error al generar horarios: ${error.message}`, 'error');
                } finally {
                    mostrarCargando(false);
                }
            }, 50);
        }

        // Aplica las restricciones de tipo 'horarioFijo'
        function aplicarRestriccionesFijas() {
            const restriccionesFijas = estado.restricciones.filter(r => r.tipo === 'horarioFijo');
            let conflictosFijos = 0;

            restriccionesFijas.forEach(restriccion => {
                const { profesorId, materiaId, aulaId, semestre, dia, hora } = restriccion;
                const profesor = estado.profesores.find(p => p.id === profesorId);
                const materia = estado.materias.find(m => m.id === materiaId);
                const aula = estado.aulas.find(a => a.id === aulaId);

                if (!profesor || !materia || !aula) {
                    console.warn("Restricción fija inválida (datos no encontrados):", restriccion);
                    return;
                }
                 // Verificar que el profesor pueda dictar la materia
                 if (!profesor.materiasQueDicta?.includes(materiaId)) {
                     console.warn(`Conflicto en restricción fija: Profesor ${profesor.nombre} no puede dictar ${materia.nombre}. Ignorando:`, restriccion);
                     conflictosFijos++;
                     return;
                 }
                 // Verificar tipo de aula
                 if (aula.tipo !== materia.tipoAula && !(materia.tipoAula === 'normal' && aula.tipo === 'normal')) {
                     console.warn(`Conflicto en restricción fija: Aula ${aula.nombre} (${aula.tipo}) no es compatible con ${materia.nombre} (${materia.tipoAula}). Ignorando:`, restriccion);
                     conflictosFijos++;
                     return;
                 }

                 // Verificar si el slot ya está ocupado (por otra restricción fija)
                 if (estado.horarios[semestre]?.[dia]?.[hora]) {
                     console.warn(`Conflicto al aplicar restricción fija: Slot ${semestre}-${dia}-${hora} ya ocupado por ${estado.horarios[semestre][dia][hora].codigo}. Ignorando:`, restriccion);
                     conflictosFijos++;
                     return;
                 }

                 // Verificar disponibilidad de profesor y aula en OTROS semestres (conflicto global)
                 if (!estaProfesorDisponible(profesor, dia, hora, semestre) || !estaAulaDisponible(aula, dia, hora, semestre)) {
                     console.warn(`Conflicto global al aplicar restricción fija (profesor/aula ocupado en otro semestre): Slot ${semestre}-${dia}-${hora}. Ignorando:`, restriccion);
                     conflictosFijos++;
                     return;
                 }

                // Asignar la sesión fija
                if (!estado.horarios[semestre]) estado.horarios[semestre] = {};
                if (!estado.horarios[semestre][dia]) estado.horarios[semestre][dia] = {};

                estado.horarios[semestre][dia][hora] = {
                    materia: materia.nombre,
                    codigo: materia.codigo, // Usar código como identificador único de materia en horario
                    profesor: profesor.nombre,
                    profesorId: profesor.id,
                    aula: aula.nombre,
                    aulaId: aula.id,
                    fijado: true // Marcar como fijado
                };
            });
             if (conflictosFijos > 0) {
                 mostrarNotificacion('Advertencia', `${conflictosFijos} restricciones fijas no pudieron aplicarse por conflictos.`, 'error');
             }
        }

        // Asigna materias para un semestre específico
        function asignarMateriasASemestre(materiasDelSemestre, semestre, diasHabiles, horasPorDia) {
            const horasAsignadasPorMateria = {}; // { materiaId: count }
            const materiasNoAsignadas = [];

            // Contar horas ya asignadas por restricciones fijas
            materiasDelSemestre.forEach(m => {
                horasAsignadasPorMateria[m.id] = 0;
                diasHabiles.forEach(dia => {
                    horasPorDia.forEach(hora => {
                        if (estado.horarios[semestre]?.[dia]?.[hora]?.codigo === m.codigo && estado.horarios[semestre]?.[dia]?.[hora]?.fijado) {
                            horasAsignadasPorMateria[m.id]++;
                        }
                    });
                });
            });

            // Ordenar materias (ej. por horas restantes, o aleatorio)
            let materiasParaAsignar = materiasDelSemestre
                .filter(m => horasAsignadasPorMateria[m.id] < m.horasSemana)
                .sort((a, b) => (b.horasSemana - horasAsignadasPorMateria[b.id]) - (a.horasSemana - horasAsignadasPorMateria[a.id])); // Priorizar las que faltan más horas

            // Iterar para asignar horas faltantes
            materiasParaAsignar.forEach(materia => {
                let horasFaltantes = materia.horasSemana - horasAsignadasPorMateria[materia.id];

                // Iterar por días y horas buscando slots libres
                for (const dia of diasHabiles) {
                    if (horasFaltantes <= 0) break;
                    for (const hora of horasPorDia) {
                        if (horasFaltantes <= 0) break;

                        // Verificar si el slot está libre EN ESTE SEMESTRE
                        if (!estado.horarios[semestre]?.[dia]?.[hora]) {
                            // Buscar profesor y aula disponibles GLOBALMENTE
                            const profesor = buscarProfesorDisponible(dia, hora, materia);
                            const aula = buscarAulaDisponible(dia, hora, materia.tipoAula);

                            if (profesor && aula) {
                                // Asignar la sesión
                                estado.horarios[semestre][dia][hora] = {
                                    materia: materia.nombre,
                                    codigo: materia.codigo,
                                    profesor: profesor.nombre,
                                    profesorId: profesor.id,
                                    aula: aula.nombre,
                                    aulaId: aula.id,
                                    fijado: false // No fijado por defecto
                                };
                                horasFaltantes--;
                                horasAsignadasPorMateria[materia.id]++;
                            }
                        }
                    }
                }
                 // Si aún faltan horas, registrar la materia como no asignada completamente
                 if (horasFaltantes > 0) {
                     materiasNoAsignadas.push({ materia: materia.nombre, faltantes: horasFaltantes });
                     console.warn(`No se pudieron asignar ${horasFaltantes} horas para ${materia.nombre} (Sem ${semestre})`);
                 }
            });

            return { noAsignadas: materiasNoAsignadas };
        }

        // Busca un profesor disponible (considerando preferencia y disponibilidad global)
        function buscarProfesorDisponible(dia, hora, materia) {
            // 1. Filtrar profesores que PUEDEN dictar la materia
            const profesoresAsignados = estado.profesores.filter(p => p.materiasQueDicta?.includes(materia.id));

            // 2. De esos, encontrar los que están DISPONIBLES en ese día/hora globalmente
            const profesoresDisponibles = profesoresAsignados.filter(p =>
                estaProfesorDisponible(p, dia, hora)
            );

            if (profesoresDisponibles.length > 0) {
                // Devolver uno aleatorio o basado en alguna heurística (ej. menos carga horaria)
                // TODO: Implementar heurística de carga si se desea
                return profesoresDisponibles[Math.floor(Math.random() * profesoresDisponibles.length)];
            }

            // 3. Si no hay profesores disponibles que puedan dictar la materia, retornar null
            return null;
        }

        // Verifica si un profesor está disponible (horario y disponibilidad semanal)
        function estaProfesorDisponible(profesor, dia, hora, semestreExcluir = null) {
            // A. Verificar disponibilidad semanal básica (Mañana/Tarde)
            const turno = obtenerTurno(hora);
            if (!profesor.diasDisponibles?.[dia]?.[turno]) {
                 // console.log(`Profesor ${profesor.codigo} NO disponible por horario semanal: ${dia} ${turno}`);
                return false; // No disponible según su horario base
            }

            // B. Verificar si ya tiene clase asignada en CUALQUIER semestre (excepto el excluido, si se especifica)
            for (const sem in estado.horarios) {
                 if (semestreExcluir && sem == semestreExcluir) continue; // Saltar el semestre a excluir

                if (estado.horarios[sem]?.[dia]?.[hora]?.profesorId === profesor.id) {
                     // console.log(`Profesor ${profesor.codigo} OCUPADO en Sem ${sem} a las ${dia} ${hora}`);
                    return false; // Ocupado en otro semestre
                }
            }

            // Si pasó ambas verificaciones, está disponible
            return true;
        }

        // Busca un aula disponible (considerando tipo y disponibilidad global)
        function buscarAulaDisponible(dia, hora, tipoRequerido) {
            const aulasCompatibles = estado.aulas.filter(a => a.tipo === tipoRequerido || (tipoRequerido === 'normal' && a.tipo === 'normal')); // Aula normal sirve para materia normal

            const aulasLibres = aulasCompatibles.filter(aula => estaAulaDisponible(aula, dia, hora));

            if (aulasLibres.length > 0) {
                // Devolver una aleatoria o basada en heurística (ej. capacidad más cercana)
                // TODO: Implementar heurística de capacidad si se desea
                return aulasLibres[Math.floor(Math.random() * aulasLibres.length)];
            }
            return null;
        }

        // Verifica si un aula está disponible globalmente
        function estaAulaDisponible(aula, dia, hora, semestreExcluir = null) {
            for (const sem in estado.horarios) {
                 if (semestreExcluir && sem == semestreExcluir) continue;

                if (estado.horarios[sem]?.[dia]?.[hora]?.aulaId === aula.id) {
                    return false; // Ocupada
                }
            }
            return true; // Libre
        }

        // Función para optimizar horarios (placeholder/simplificada)
        function optimizarHorarios() {
            if (!estado.horarios || Object.keys(estado.horarios).length === 0) {
                mostrarNotificacion('Error', 'Primero debe generar horarios.', 'error');
                return;
            }
            mostrarCargando(true);
            setTimeout(() => {
                try {
                    console.log("Iniciando optimización...");
                    let cambiosRealizados = 0;
                    const maxIteraciones = parseInt(document.getElementById('maxIteraciones').value) || 1000;
                    const informeOpt = { conflictosResueltos: 0, huecosOptimizados: 0, movimientos: 0 };

                    // Algoritmo simple: intentar mover sesiones aleatoriamente para resolver conflictos
                    for (let i = 0; i < maxIteraciones; i++) {
                        const conflictos = [...detectarConflictos('profesor'), ...detectarConflictos('aula')];
                        if (conflictos.length === 0) break; // No hay más conflictos

                        // Elegir un conflicto al azar
                        const conflicto = conflictos[Math.floor(Math.random() * conflictos.length)];
                        // Priorizar mover la sesión NO fijada, si existe
                        const sesionAMover = !conflicto.sesion1.fijado ? conflicto.sesion1 : (!conflicto.sesion2.fijado ? conflicto.sesion2 : null);

                        if (sesionAMover) {
                            // Intentar mover la sesión a un slot vacío cercano
                            const movido = intentarMoverSesion(sesionAMover.semestre, conflicto.dia, conflicto.hora);
                            if (movido) {
                                informeOpt.conflictosResueltos++;
                                informeOpt.movimientos++;
                                cambiosRealizados++;
                            }
                        } else {
                            // Ambas sesiones del conflicto están fijadas, no se puede resolver moviendo
                            console.warn("Conflicto entre sesiones fijadas no resoluble:", conflicto);
                        }
                    }

                     // Optimización de huecos (ejemplo simple)
                     const huecosOptimizados = optimizarHuecosEstudiante();
                     informeOpt.huecosOptimizados = huecosOptimizados;
                     cambiosRealizados += huecosOptimizados;


                    console.log("Optimización completada.");
                    generarHorariosVisualizacion(); // Recalcular vistas
                    actualizarHorarioVisible();
                    actualizarEstadisticasHorario();
                    renderizarProfesores(); // Actualizar carga detallada
                    guardarDatosLocalmente();

                    if (cambiosRealizados > 0) {
                         mostrarInformeOptimizacion(informeOpt);
                         mostrarNotificacion('Éxito', `Optimización completada. ${informeOpt.conflictosResueltos} conflictos resueltos, ${informeOpt.huecosOptimizados} huecos optimizados.`, 'success');
                    } else {
                         mostrarNotificacion('Información', 'No se realizaron cambios durante la optimización.', 'info');
                    }

                } catch (error) {
                    console.error("Error optimizando horarios:", error);
                    mostrarNotificacion('Error', `Error al optimizar: ${error.message}`, 'error');
                } finally {
                    mostrarCargando(false);
                }
            }, 50);
        }

        // Intenta mover una sesión a un slot cercano y válido
        function intentarMoverSesion(semestre, diaOrigen, horaOrigen) {
            const sesion = estado.horarios[semestre]?.[diaOrigen]?.[horaOrigen];
            if (!sesion || sesion.fijado) return false; // No mover sesiones fijadas

            const diasHabiles = obtenerDiasHabiles();
            const horasPorDia = calcularHorasPorDia();
            const profesor = estado.profesores.find(p => p.id === sesion.profesorId);
            const aula = estado.aulas.find(a => a.id === sesion.aulaId);
            if (!profesor || !aula) return false; // Datos inconsistentes

            // Buscar slots alternativos (ej. mismo día, horas cercanas; otros días)
            // Crear una lista aleatoria de slots para probar
            const slotsPosibles = [];
            for (const dia of diasHabiles) {
                for (const hora of horasPorDia) {
                    if (dia !== diaOrigen || hora !== horaOrigen) {
                        slotsPosibles.push({ dia, hora });
                    }
                }
            }
            // Barajar slots para aleatoriedad
            for (let i = slotsPosibles.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [slotsPosibles[i], slotsPosibles[j]] = [slotsPosibles[j], slotsPosibles[i]];
            }


            for (const { dia: diaDestino, hora: horaDestino } of slotsPosibles) {
                // Verificar si el slot destino está libre en este semestre
                if (!estado.horarios[semestre]?.[diaDestino]?.[horaDestino]) {
                     // Verificar disponibilidad global de profesor y aula en el nuevo slot
                     if (estaProfesorDisponible(profesor, diaDestino, horaDestino, semestre) && estaAulaDisponible(aula, diaDestino, horaDestino, semestre)) {
                         // Mover la sesión
                         if (!estado.horarios[semestre][diaDestino]) estado.horarios[semestre][diaDestino] = {};
                         estado.horarios[semestre][diaDestino][horaDestino] = { ...sesion }; // Copiar sesión
                         delete estado.horarios[semestre][diaOrigen][horaOrigen]; // Eliminar original
                         console.log(`Movido: ${sesion.codigo} de ${diaOrigen}-${horaOrigen} a ${diaDestino}-${horaDestino}`);
                         return true; // Movimiento exitoso
                     }
                }
            }
            return false; // No se pudo mover
        }

        // Detecta conflictos de profesor o aula
        function detectarConflictos(tipo) { // tipo = 'profesor' o 'aula'
            const conflictos = [];
            const asignaciones = {}; // clave: 'dia-hora-entidadId', valor: { semestre, materiaId, fijado, profesorId, aulaId }
            const diasHabiles = obtenerDiasHabiles();
            const horasPorDia = calcularHorasPorDia();

            for (const semestre in estado.horarios) {
                for (const dia of diasHabiles) {
                    for (const hora of horasPorDia) {
                        const sesion = estado.horarios[semestre]?.[dia]?.[hora];
                        if (sesion) {
                            const entidadId = (tipo === 'profesor') ? sesion.profesorId : sesion.aulaId;
                            if (entidadId) {
                                const clave = `${dia}-${hora}-${entidadId}`;
                                if (asignaciones[clave]) { // Conflicto detectado
                                    const sesionConflicto = asignaciones[clave];
                                    // Solo reportar si no es la misma sesión (caso raro) y si al menos una no está fijada
                                    if (sesionConflicto.semestre !== semestre || sesionConflicto.materiaId !== sesion.codigo) {
                                         conflictos.push({
                                            tipo: tipo, dia, hora, entidadId,
                                            sesion1: { semestre, materiaId: sesion.codigo, profesorId: sesion.profesorId, aulaId: sesion.aulaId, fijado: sesion.fijado },
                                            sesion2: { semestre: sesionConflicto.semestre, materiaId: sesionConflicto.materiaId, profesorId: sesionConflicto.profesorId, aulaId: sesionConflicto.aulaId, fijado: sesionConflicto.fijado }
                                        });
                                    }
                                } else {
                                    asignaciones[clave] = { semestre, materiaId: sesion.codigo, fijado: sesion.fijado, profesorId: sesion.profesorId, aulaId: sesion.aulaId };
                                }
                            }
                        }
                    }
                }
            }
            return conflictos;
        }

        // Optimiza huecos para estudiantes (versión simplificada)
        function optimizarHuecosEstudiante() {
             // Esta es una heurística muy simple. Una optimización real requeriría
             // modelar grupos de estudiantes o evaluar el impacto en todos los semestres.
             let huecosOptimizados = 0;
             const diasHabiles = obtenerDiasHabiles();
             const horasPorDia = calcularHorasPorDia();

             for (const semestre in estado.horarios) {
                 for (const dia of diasHabiles) {
                     const horasOcupadas = horasPorDia.filter(h => estado.horarios[semestre]?.[dia]?.[h]);
                     if (horasOcupadas.length < 2) continue; // No hay huecos posibles

                     horasOcupadas.sort((a, b) => horasPorDia.indexOf(a) - horasPorDia.indexOf(b)); // Ordenar

                     // Buscar huecos e intentar mover la sesión posterior al hueco
                     for (let i = 0; i < horasOcupadas.length - 1; i++) {
                         const idxActual = horasPorDia.indexOf(horasOcupadas[i]);
                         const idxSiguiente = horasPorDia.indexOf(horasOcupadas[i+1]);

                         if (idxSiguiente > idxActual + 1) { // Hay un hueco
                             const horaDestino = horasPorDia[idxActual + 1]; // Slot inmediatamente después
                             const horaOrigen = horasOcupadas[i+1];
                             const sesionAMover = estado.horarios[semestre]?.[dia]?.[horaOrigen];

                             if (sesionAMover && !sesionAMover.fijado) {
                                 // Intentar mover la sesión siguiente al slot del hueco
                                 const profesor = estado.profesores.find(p => p.id === sesionAMover.profesorId);
                                 const aula = estado.aulas.find(a => a.id === sesionAMover.aulaId);

                                 if (profesor && aula && !estado.horarios[semestre]?.[dia]?.[horaDestino] && // Slot destino libre en este semestre
                                     estaProfesorDisponible(profesor, dia, horaDestino, semestre) &&
                                     estaAulaDisponible(aula, dia, horaDestino, semestre))
                                 {
                                     // Mover
                                     if (!estado.horarios[semestre][dia]) estado.horarios[semestre][dia] = {};
                                     estado.horarios[semestre][dia][horaDestino] = { ...sesionAMover };
                                     delete estado.horarios[semestre][dia][horaOrigen];
                                     console.log(`Hueco optimizado: ${sesionAMover.codigo} movido de ${horaOrigen} a ${horaDestino} en ${dia} S${semestre}`);
                                     huecosOptimizados++;
                                     // Re-evaluar el día después de un movimiento exitoso
                                     horasOcupadas = horasPorDia.filter(h => estado.horarios[semestre]?.[dia]?.[h]).sort((a, b) => horasPorDia.indexOf(a) - horasPorDia.indexOf(b));
                                     i = -1; // Reiniciar bucle para el día
                                 }
                             }
                         }
                     }
                 }
             }
             return huecosOptimizados;
        }


        // --- RESTRICCIONES ---

        // Guardar restricciones ponderables
        function guardarRestricciones() {
            // Limpiar restricciones ponderables anteriores
            estado.restricciones = estado.restricciones.filter(r => r.tipo === 'horarioFijo');

            // Añadir restricciones ponderables actuales
            estado.restricciones.push({
                tipo: 'evitarHuecos', // Ponderable
                peso: parseInt(document.getElementById('evitarHuecosPeso').value) || 8
            });
            estado.restricciones.push({
                tipo: 'maxHorasConsecutivas', // Ponderable
                valor: parseInt(document.getElementById('maxHorasConsecutivasValor').value) || 4,
                peso: parseInt(document.getElementById('maxHorasConsecutivasPeso').value) || 7
            });
             // Las estrictas (disponibilidad, tipo aula) se manejan implícitamente

            guardarDatosLocalmente();
            mostrarNotificacion('Éxito', 'Restricciones ponderables guardadas.', 'success');
        }

        // Fijar un horario específico (añade restricción 'horarioFijo')
        function fijarHorarioProfesor() {
            const profesorId = document.getElementById('profesorRestriccion').value;
            const materiaId = document.getElementById('materiaRestriccion').value;
            const aulaId = document.getElementById('aulaRestriccion').value;
            const dia = document.getElementById('diaRestriccion').value;
            const hora = document.getElementById('horaRestriccion').value;

            if (!profesorId || !materiaId || !aulaId || !dia || !hora) {
                mostrarNotificacion('Error', 'Todos los campos son obligatorios para fijar horario.', 'error');
                return;
            }

            const materia = estado.materias.find(m => m.id === materiaId);
            const profesor = estado.profesores.find(p => p.id === profesorId);
            const aula = estado.aulas.find(a => a.id === aulaId);
            if (!materia || !profesor || !aula) {
                 mostrarNotificacion('Error', 'Profesor, Materia o Aula no encontrados.', 'error');
                 return;
            }
            // Validar que el profesor pueda dictar la materia
            if (!profesor.materiasQueDicta?.includes(materiaId)) {
                 mostrarNotificacion('Error', `El profesor ${profesor.nombre} no está asignado para dictar ${materia.nombre}.`, 'error');
                 return;
            }
             // Validar tipo de aula
             if (aula.tipo !== materia.tipoAula && !(materia.tipoAula === 'normal' && aula.tipo === 'normal')) {
                 mostrarNotificacion('Error', `El aula '${aula.nombre}' (${aula.tipo}) no es compatible con la materia '${materia.nombre}' que requiere tipo '${materia.tipoAula}'.`, 'error');
                 return;
             }

            const semestre = materia.semestre;

            // Verificar si ya existe una restricción fija en conflicto EXACTO (mismo P, M, A, D, H)
            const existeExacta = estado.restricciones.some(r =>
                r.tipo === 'horarioFijo' && r.dia === dia && r.hora === hora &&
                r.profesorId === profesorId && r.materiaId === materiaId && r.aulaId === aulaId && r.semestre === semestre
            );
            if (existeExacta) {
                 mostrarNotificacion('Info', 'Esta restricción fija ya existe.', 'info');
                 return;
            }

            // Verificar si ya existe una restricción fija que cause conflicto (P, A o S en mismo slot)
            const existeConflictoRestriccion = estado.restricciones.some(r =>
                r.tipo === 'horarioFijo' && r.dia === dia && r.hora === hora &&
                (r.profesorId === profesorId || r.aulaId === aulaId || r.semestre === semestre)
            );
            if (existeConflictoRestriccion) {
                 mostrarNotificacion('Advertencia', 'Ya existe una restricción fija en conflicto (Profesor, Aula o Semestre) para este horario.', 'error');
                 return;
            }

            // Verificar si ya existe una sesión asignada (no fija) en ese slot
            const slotOcupado = estado.horarios[semestre]?.[dia]?.[hora];
            if (slotOcupado && !slotOcupado.fijado) {
                 if (!confirm(`El horario ${dia} ${hora} para el semestre ${semestre} ya está ocupado por ${slotOcupado.materia}. ¿Desea sobrescribirlo y fijarlo?`)) {
                     return;
                 }
                 // Si confirma, la asignación se hará abajo, sobrescribiendo
            } else if (slotOcupado && slotOcupado.fijado) {
                 mostrarNotificacion('Error', 'El horario seleccionado ya está fijado con otra materia/profesor.', 'error');
                 return;
            }


            estado.restricciones.push({
                tipo: 'horarioFijo', profesorId, materiaId, aulaId, semestre, dia, hora
            });

            // Opcional: Aplicar inmediatamente al horario si no hay conflicto
            if (!slotOcupado) { // Solo si estaba vacío
                aplicarRestriccionesFijas(); // Re-aplicar para que aparezca en el horario
                generarHorariosVisualizacion();
                actualizarHorarioVisible();
            } else if (slotOcupado && !slotOcupado.fijado) { // Si se confirmó sobrescribir
                 aplicarRestriccionesFijas(); // Re-aplicar para sobrescribir y fijar
                 generarHorariosVisualizacion();
                 actualizarHorarioVisible();
            }


            renderizarListaHorariosFijos(); // Actualizar lista en UI
            guardarDatosLocalmente(); // Guardar la nueva restricción
            mostrarNotificacion('Éxito', 'Horario fijado como restricción.', 'success');

            // Limpiar selectores
            document.getElementById('profesorRestriccion').value = '';
            document.getElementById('materiaRestriccion').innerHTML = '<option value="">Seleccione materia</option>';
            document.getElementById('aulaRestriccion').innerHTML = '<option value="">Seleccione aula</option>';
            document.getElementById('diaRestriccion').value = '';
            document.getElementById('horaRestriccion').value = '';
        }

        // Eliminar una restricción de horario fijo por índice
        function eliminarHorarioFijo(index) {
            const horariosFijos = estado.restricciones.filter(r => r.tipo === 'horarioFijo');
            if (index >= 0 && index < horariosFijos.length) {
                const restriccionAEliminar = horariosFijos[index];
                // Encontrar el índice real en el array 'estado.restricciones'
                const indiceReal = estado.restricciones.findIndex(r => r === restriccionAEliminar);
                if (indiceReal !== -1) {
                    estado.restricciones.splice(indiceReal, 1);

                    // Opcional: Des-fijar la sesión correspondiente en el horario si existe
                    const { semestre, dia, hora, materiaId } = restriccionAEliminar;
                    if (estado.horarios[semestre]?.[dia]?.[hora]?.codigo === materiaId && estado.horarios[semestre][dia][hora].fijado) {
                        estado.horarios[semestre][dia][hora].fijado = false;
                        generarHorariosVisualizacion();
                        actualizarHorarioVisible();
                    }

                    renderizarListaHorariosFijos();
                    guardarDatosLocalmente();
                    mostrarNotificacion('Éxito', 'Restricción de horario fijo eliminada.', 'success');
                }
            }
        }

        // --- EDICIÓN MANUAL DE HORARIOS ---

        // Activar/Desactivar modo edición
        function toggleModoEdicion() {
            estado.modoEdicion = !estado.modoEdicion;
            const btn = document.getElementById('modoEdicionBtn');
            const tablaHorario = document.getElementById('tablaHorario');

            if (estado.modoEdicion) {
                btn.textContent = "Salir de Edición";
                btn.classList.replace('bg-yellow-500', 'bg-red-600');
                btn.classList.replace('hover:bg-yellow-600', 'hover:bg-red-700');
                tablaHorario.classList.add('modo-edicion-activo'); // Clase para estilos visuales si es necesario
                mostrarNotificacion('Información', 'Modo edición ACTIVADO. Doble clic en una sesión para editar.', 'info');
            } else {
                btn.textContent = "Editar Manualmente";
                btn.classList.replace('bg-red-600', 'bg-yellow-500');
                btn.classList.replace('hover:bg-red-700', 'hover:bg-yellow-600');
                 tablaHorario.classList.remove('modo-edicion-activo');
                mostrarNotificacion('Información', 'Modo edición DESACTIVADO.', 'info');
            }
        }

        // Mostrar modal para editar una sesión específica
        function mostrarModalSesion(dia, hora, semestre) {
            const sesion = estado.horarios[semestre]?.[dia]?.[hora];
            if (!sesion) return;

            const modal = document.getElementById('modalSesion');
            document.getElementById('sesionDia').value = dia;
            document.getElementById('sesionHora').value = hora;
            document.getElementById('sesionSemestre').value = semestre;
            document.getElementById('sesionOriginalMateriaId').value = sesion.codigo; // Guardar ID original

            // Poblar selectores
            const materiaSelect = document.getElementById('sesionMateria');
            const profesorSelect = document.getElementById('sesionProfesor');
            const aulaSelect = document.getElementById('sesionAula');
            materiaSelect.innerHTML = ''; profesorSelect.innerHTML = ''; aulaSelect.innerHTML = '';

            // Materias (del mismo semestre preferiblemente, pero mostrar todas por simplicidad)
            estado.materias.sort((a,b) => a.nombre.localeCompare(b.nombre)).forEach(m => {
                const opt = new Option(`${m.nombre} (S${m.semestre})`, m.id);
                if (m.codigo === sesion.codigo) opt.selected = true;
                materiaSelect.appendChild(opt);
            });

            // Actualizar aulas y profesores si cambia la materia en el modal
             materiaSelect.onchange = () => {
                 aulaSelect.innerHTML = '';
                 profesorSelect.innerHTML = ''; // Limpiar profesores también
                 const matId = materiaSelect.value;
                 const mat = estado.materias.find(m => m.id === matId);
                 const tipoReq = mat?.tipoAula || 'normal';

                 // Poblar Aulas compatibles
                 estado.aulas
                    .filter(a => a.tipo === tipoReq || (tipoReq === 'normal' && a.tipo === 'normal'))
                    .sort((a,b) => a.nombre.localeCompare(b.nombre))
                    .forEach(a => {
                        const opt = new Option(`${a.nombre} (${a.tipo})`, a.id);
                        // Seleccionar el aula original si es compatible con la nueva materia
                        if (a.id === sesion.aulaId && (a.tipo === tipoReq || (tipoReq === 'normal' && a.tipo === 'normal'))) {
                            opt.selected = true;
                        }
                        aulaSelect.appendChild(opt);
                    });

                 // Poblar Profesores que pueden dictar la materia seleccionada
                 estado.profesores
                    .filter(p => p.materiasQueDicta?.includes(matId))
                    .sort((a,b) => a.nombre.localeCompare(b.nombre))
                    .forEach(p => {
                        const opt = new Option(p.nombre, p.id);
                         // Seleccionar el profesor original si puede dictar la nueva materia
                        if (p.id === sesion.profesorId && p.materiasQueDicta?.includes(matId)) {
                            opt.selected = true;
                        }
                        profesorSelect.appendChild(opt);
                    });
             };

             // Disparar el onchange inicial para poblar aulas y profesores
             materiaSelect.dispatchEvent(new Event('change'));


            document.getElementById('sesionFijada').checked = sesion.fijado || false;

            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        // Guardar cambios de la sesión editada
        function guardarSesionEditada() {
            const dia = document.getElementById('sesionDia').value;
            const hora = document.getElementById('sesionHora').value;
            const semestre = document.getElementById('sesionSemestre').value;
            const materiaId = document.getElementById('sesionMateria').value;
            const profesorId = document.getElementById('sesionProfesor').value;
            const aulaId = document.getElementById('sesionAula').value;
            const fijado = document.getElementById('sesionFijada').checked;

            if (!materiaId || !profesorId || !aulaId) {
                mostrarNotificacion('Error', 'Debe seleccionar materia, profesor y aula.', 'error');
                return;
            }

            const materia = estado.materias.find(m => m.id === materiaId);
            const profesor = estado.profesores.find(p => p.id === profesorId);
            const aula = estado.aulas.find(a => a.id === aulaId);

            if (!materia || !profesor || !aula) {
                mostrarNotificacion('Error', 'Datos inválidos seleccionados.', 'error');
                return;
            }
             // Validar que el profesor pueda dictar la materia
             if (!profesor.materiasQueDicta?.includes(materiaId)) {
                 mostrarNotificacion('Error', `El profesor ${profesor.nombre} no está asignado para dictar ${materia.nombre}.`, 'error');
                 return;
             }

             // Verificar conflictos ANTES de guardar
             // Conflicto en el mismo semestre ya está cubierto (se sobrescribe)
             // Verificar conflicto global para profesor y aula
             if (!estaProfesorDisponible(profesor, dia, hora, semestre) || !estaAulaDisponible(aula, dia, hora, semestre)) {
                  mostrarNotificacion('Error', 'Conflicto detectado: El profesor o el aula ya están ocupados en otro semestre en este horario.', 'error');
                  return;
             }
             // Verificar si el tipo de aula es compatible
             if (aula.tipo !== materia.tipoAula && !(materia.tipoAula === 'normal' && aula.tipo === 'normal')) {
                  mostrarNotificacion('Error', `El aula '${aula.nombre}' (${aula.tipo}) no es compatible con la materia '${materia.nombre}' que requiere tipo '${materia.tipoAula}'.`, 'error');
                  return;
             }


            // Actualizar la sesión
            estado.horarios[semestre][dia][hora] = {
                materia: materia.nombre,
                codigo: materia.codigo,
                profesor: profesor.nombre,
                profesorId: profesor.id,
                aula: aula.nombre,
                aulaId: aula.id,
                fijado: fijado
            };

            cerrarModal('modalSesion');
            generarHorariosVisualizacion(); // Recalcular vistas por si cambió profesor/aula/materia
            actualizarHorarioVisible(); // Renderizar tabla
            actualizarEstadisticasHorario(); // Actualizar contadores
            renderizarProfesores(); // Actualizar carga detallada
            guardarDatosLocalmente();
            mostrarNotificacion('Éxito', 'Sesión actualizada correctamente.', 'success');
        }

        // Eliminar una sesión del horario
        function eliminarSesion() {
            const dia = document.getElementById('sesionDia').value;
            const hora = document.getElementById('sesionHora').value;
            const semestre = document.getElementById('sesionSemestre').value;

            if (estado.horarios[semestre]?.[dia]?.[hora]) {
                if (confirm(`¿Está seguro de eliminar la sesión de ${estado.horarios[semestre][dia][hora].materia} en ${dia} a las ${hora}?`)) {
                    delete estado.horarios[semestre][dia][hora];
                    cerrarModal('modalSesion'); // Cerrar modal
                    generarHorariosVisualizacion();
                    actualizarHorarioVisible();
                    actualizarEstadisticasHorario();
                    renderizarProfesores(); // Actualizar carga detallada
                    guardarDatosLocalmente();
                    mostrarNotificacion('Éxito', 'Sesión eliminada.', 'success');
                }
            } else {
                mostrarNotificacion('Error', 'No se encontró la sesión para eliminar.', 'error');
                cerrarModal('modalSesion');
            }
        }

        // --- UTILIDADES Y UI ---

        // Mostrar/Ocultar pantalla de carga
        function mostrarCargando(mostrar) {
            document.getElementById('loadingScreen').style.display = mostrar ? 'flex' : 'none';
        }

        // Mostrar notificación flotante
        function mostrarNotificacion(titulo, mensaje, tipo = 'info') { // info, success, error
            const notification = document.getElementById('notification');
            document.getElementById('notificationTitle').textContent = titulo;
            document.getElementById('notificationMessage').textContent = mensaje;

            notification.classList.remove('bg-blue-100', 'text-blue-700', 'bg-green-100', 'text-green-700', 'bg-red-100', 'text-red-700', 'bg-gray-100', 'text-gray-700');
            let bgColor, textColor;
            switch (tipo) {
                case 'success': bgColor = 'bg-green-100'; textColor = 'text-green-700'; break;
                case 'error': bgColor = 'bg-red-100'; textColor = 'text-red-700'; break;
                case 'info':
                default: bgColor = 'bg-blue-100'; textColor = 'text-blue-700'; break;
            }
            notification.classList.add(bgColor, textColor);

            notification.classList.remove('hidden');
            requestAnimationFrame(() => { // Asegura que se aplique el cambio de display antes de la transición
                 notification.classList.add('show');
            });


            // Ocultar automáticamente después de 5 segundos
            setTimeout(() => {
                notification.classList.remove('show');
                // Esperar a que termine la transición antes de ocultar con display:none
                setTimeout(() => notification.classList.add('hidden'), 300);
            }, 5000);
        }

        // Calcular horas del día según configuración
        function calcularHorasPorDia() {
            const { horaInicio, horaFin, duracionBloque } = estado.configuracion;
            const horas = [];
            if (!horaInicio || !horaFin || !duracionBloque) return horas; // Evitar error si no hay config

            try {
                let [hIni, mIni] = horaInicio.split(':').map(Number);
                let [hFin, mFin] = horaFin.split(':').map(Number);
                let minutosActual = hIni * 60 + mIni;
                const minutosFin = hFin * 60 + mFin;

                while (minutosActual < minutosFin) {
                    const h = Math.floor(minutosActual / 60);
                    const m = minutosActual % 60;
                    horas.push(`${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}`);
                    minutosActual += parseInt(duracionBloque);
                }
            } catch (e) {
                console.error("Error calculando horas:", e);
                mostrarNotificacion('Error', 'Formato de hora inválido en configuración.', 'error');
            }
            return horas;
        }

        // Obtener días hábiles según configuración
        function obtenerDiasHabiles() {
            return estado.configuracion.diasDisponibles || ["Lunes", "Martes", "Miércoles", "Jueves", "Viernes"];
        }

        // Obtener turno (mañana/tarde) basado en la hora
        function obtenerTurno(hora) {
            if (!hora) return null;
            try {
                const horaNum = parseInt(hora.split(':')[0]);
                return horaNum < 13 ? 'mañana' : 'tarde'; // Asumiendo que las 13:00 es el inicio de la tarde
            } catch {
                return null;
            }
        }

        // Guardar estado en localStorage
        function guardarDatosLocalmente() {
            try {
                localStorage.setItem('datosHorariosAppVD3', JSON.stringify({ // Cambiado nombre de clave para evitar conflictos
                    profesores: estado.profesores,
                    materias: estado.materias,
                    aulas: estado.aulas,
                    restricciones: estado.restricciones,
                    horarios: estado.horarios,
                    horariosAsesorias: estado.horariosAsesorias || {},
                    configuracion: estado.configuracion
                }));
                 // console.log("Datos guardados localmente.");
            } catch (error) {
                console.error("Error guardando datos localmente:", error);
                mostrarNotificacion('Error', 'No se pudieron guardar los datos localmente (posiblemente localStorage lleno).', 'error');
            }
        }

        // Cargar estado desde localStorage
        function cargarDatosGuardados() {
            const datosGuardados = localStorage.getItem('datosHorariosAppVD3'); // Usar nueva clave
            if (datosGuardados) {
                try {
                    const datos = JSON.parse(datosGuardados);
                    estado.profesores = datos.profesores || [];
                    estado.materias = datos.materias || [];
                    estado.aulas = datos.aulas || [];
                    estado.restricciones = datos.restricciones || [];
                    estado.horarios = datos.horarios || {};
                    estado.horariosAsesorias = datos.horariosAsesorias || {};
                    // Fusionar configuración guardada con la por defecto, asegurando que existan las nuevas estructuras
                    const defaultConfig = {
                        periodoAcademico: "semestral", cantidadSemestres: 4, horaInicio: "06:00", horaFin: "18:00", duracionBloque: 60,
                        diasDisponibles: ["Lunes", "Martes", "Miércoles", "Jueves", "Viernes"],
                        asesoriasNormalesConfig: { habilitado: false, duracionMinutos: 60, vecesPorSemana: 1 },
                        asesoriasEvaluacionConfig: { habilitado: false, duracionMinutos: 120, vecesPorSemana: 1 },
                        habilitarAsesorias: false, duracionAsesoria: 30 // Mantener obsoletos por si acaso
                    };
                    estado.configuracion = { ...defaultConfig, ...(datos.configuracion || {}) };
                     // Asegurar que las sub-estructuras de config existan
                    if (!estado.configuracion.asesoriasNormalesConfig) estado.configuracion.asesoriasNormalesConfig = defaultConfig.asesoriasNormalesConfig;
                    if (!estado.configuracion.asesoriasEvaluacionConfig) estado.configuracion.asesoriasEvaluacionConfig = defaultConfig.asesoriasEvaluacionConfig;


                    // Asegurar que diasDisponibles sea un array
                    if (!Array.isArray(estado.configuracion.diasDisponibles)) {
                         estado.configuracion.diasDisponibles = defaultConfig.diasDisponibles;
                    }
                     // Asegurar estructura de disponibilidad, materiasQueDicta y campos de carga en profesores cargados
                     estado.profesores.forEach(p => {
                         if (!p.diasDisponibles) {
                             p.diasDisponibles = {};
                             ["Lunes", "Martes", "Miércoles", "Jueves", "Viernes", "Sábado"].forEach(d => {
                                 p.diasDisponibles[d] = { mañana: (d !== 'Sábado'), tarde: (d !== 'Sábado') };
                             });
                         }
                         if (!Array.isArray(p.materiasQueDicta)) p.materiasQueDicta = [];
                         // Inicializar campos de carga si no existen
                         p.horasInvestigacionSemanal = p.horasInvestigacionSemanal || 0;
                         p.horasProyectosInstSemanal = p.horasProyectosInstSemanal || 0;
                         p.horasProyectosExtSemanal = p.horasProyectosExtSemanal || 0;
                         p.horasMaterialDidacticoSemanal = p.horasMaterialDidacticoSemanal || 0;
                         p.horasCapacitacionSemestral = p.horasCapacitacionSemestral || 0;
                         // p.horasObjetivoSemanal = p.horasObjetivoSemanal || null; // Opcional
                     });


                    if (Object.keys(estado.horarios).length > 0) {
                        generarHorariosVisualizacion(); // Precalcular vistas si hay horarios
                    }
                    console.log("Datos cargados desde localStorage.");
                } catch (error) {
                    console.error("Error cargando datos desde localStorage:", error);
                    localStorage.removeItem('datosHorariosAppVD3'); // Limpiar datos corruptos
                }
            }
        }

        // Generar estructuras de visualización (por profesor, aula, materia)
        function generarHorariosVisualizacion() {
            estado.horariosVisualizacion = { porSemestre: {}, porProfesor: {}, porAula: {}, porMateria: {} };
            const diasHabiles = obtenerDiasHabiles();
            const horasPorDia = calcularHorasPorDia();

            // Asegurar que todos los semestres configurados existan en horariosVisualizacion.porSemestre
            const cantSem = parseInt(estado.configuracion.cantidadSemestres) || 1;
            for (let i = 1; i <= cantSem; i++) {
                if (!estado.horariosVisualizacion.porSemestre[i]) {
                    estado.horariosVisualizacion.porSemestre[i] = estado.horarios[i] || {}; // Usar datos o vacío
                }
            }

            for (const semestre in estado.horarios) {
                // Copia directa para porSemestre (ya se hizo arriba, pero aseguramos)
                if (!estado.horariosVisualizacion.porSemestre[semestre]) {
                    estado.horariosVisualizacion.porSemestre[semestre] = estado.horarios[semestre];
                }

                for (const dia of diasHabiles) {
                    for (const hora of horasPorDia) {
                        const sesion = estado.horarios[semestre]?.[dia]?.[hora];
                        if (sesion) {
                            const sesionConSemestre = { ...sesion, semestre };

                            // Por Profesor (usando profesor.id)
                            if (sesion.profesorId) {
                                if (!estado.horariosVisualizacion.porProfesor[sesion.profesorId]) estado.horariosVisualizacion.porProfesor[sesion.profesorId] = {};
                                if (!estado.horariosVisualizacion.porProfesor[sesion.profesorId][dia]) estado.horariosVisualizacion.porProfesor[sesion.profesorId][dia] = {};
                                estado.horariosVisualizacion.porProfesor[sesion.profesorId][dia][hora] = sesionConSemestre;
                            }
                            // Por Aula (usando aula.id)
                            if (sesion.aulaId) {
                                if (!estado.horariosVisualizacion.porAula[sesion.aulaId]) estado.horariosVisualizacion.porAula[sesion.aulaId] = {};
                                if (!estado.horariosVisualizacion.porAula[sesion.aulaId][dia]) estado.horariosVisualizacion.porAula[sesion.aulaId][dia] = {};
                                estado.horariosVisualizacion.porAula[sesion.aulaId][dia][hora] = sesionConSemestre;
                            }
                            // Por Materia (usando materia.codigo como ID)
                            if (sesion.codigo) {
                                if (!estado.horariosVisualizacion.porMateria[sesion.codigo]) estado.horariosVisualizacion.porMateria[sesion.codigo] = {};
                                if (!estado.horariosVisualizacion.porMateria[sesion.codigo][dia]) estado.horariosVisualizacion.porMateria[sesion.codigo][dia] = {};
                                estado.horariosVisualizacion.porMateria[sesion.codigo][dia][hora] = sesionConSemestre;
                            }
                        }
                    }
                }
            }
             // console.log("Visualizaciones generadas:", estado.horariosVisualizacion);
        }

        // Renderizar la tabla de horario según la vista seleccionada
        function renderizarHorario(tipoVista, elementoId) {
            const tablaHorario = document.getElementById('tablaHorario');
            const tablaAsesorias = document.getElementById('tablaHorarioAsesorias');
            const mensajeNoHorario = document.getElementById('mensajeNoHorario');
            const container = document.getElementById('horarioContainer');

            // Ocultar ambas tablas inicialmente
            tablaHorario.classList.add('hidden');
            tablaAsesorias.classList.add('hidden');
            mensajeNoHorario.classList.add('hidden'); // Ocultar mensaje por defecto

            // Si es vista de asesoría, llamar a su función específica y salir
            if (tipoVista === 'asesoria') {
                // Verificar si ALGUNA asesoría está habilitada
                const algunaAsesoriaHabilitada = estado.configuracion.asesoriasNormalesConfig?.habilitado || estado.configuracion.asesoriasEvaluacionConfig?.habilitado;
                if (algunaAsesoriaHabilitada) {
                    renderizarHorarioAsesorias(elementoId); // elementoId será el profesorId
                } else {
                    mensajeNoHorario.classList.remove('hidden');
                    mensajeNoHorario.querySelector('h3').textContent = "Asesorías Deshabilitadas";
                    mensajeNoHorario.querySelector('p').textContent = "Habilite las asesorías en la configuración.";
                }
                return;
            }

            // Si no hay elemento seleccionado o no hay horarios (y no es asesoría)
            if (!elementoId || !estado.horariosVisualizacion || Object.keys(estado.horarios).length === 0) {
                mensajeNoHorario.classList.remove('hidden');
                mensajeNoHorario.querySelector('h3').textContent = "No hay horarios generados";
                mensajeNoHorario.querySelector('p').textContent = 'Cargue datos y genere horarios.';
                container.classList.remove('border', 'border-gray-200'); // Quitar borde si no hay tabla
                return;
            }


            const diasHabiles = obtenerDiasHabiles();
            const horasPorDia = calcularHorasPorDia();
            const { horario: datosHorario, titulo } = obtenerDatosParaVista(tipoVista, elementoId);

            // console.log(`Renderizando vista: ${tipoVista}, Elemento: ${elementoId}, Título: ${titulo}`);
            // console.log("Datos para renderizar:", datosHorario);

            if (!datosHorario || Object.keys(datosHorario).length === 0 && titulo !== "Vista no exportable") { // Mostrar mensaje si no hay datos para la vista específica
                 mensajeNoHorario.classList.remove('hidden');
                 mensajeNoHorario.querySelector('h3').textContent = `Sin horario para ${titulo}`;
                 mensajeNoHorario.querySelector('p').textContent = 'No hay clases asignadas para esta selección.';
                 container.classList.remove('border', 'border-gray-200');
                 return;
            }


            let html = `<caption class="text-lg font-medium mb-2 caption-top text-gray-700 no-print">${titulo}</caption>`;
            html += '<thead><tr><th class="py-2 px-1 w-16">Hora</th>'; // Ancho fijo para hora
            diasHabiles.forEach(dia => { html += `<th class="py-2 px-1">${dia}</th>`; });
            html += '</tr></thead><tbody>';

            const conflictos = [...detectarConflictos('profesor'), ...detectarConflictos('aula')];

            horasPorDia.forEach(hora => {
                html += `<tr><td class="py-1 px-1 font-medium bg-gray-50 text-xs">${hora}</td>`;
                diasHabiles.forEach(dia => {
                    const sesion = datosHorario[dia]?.[hora];
                    let cellClasses = "p-1 h-16"; // Altura mínima
                    let divClasses = "session text-xs"; // Tamaño base para sesión
                    let content = '';

                    if (sesion) {
                        // Verificar si esta sesión está en conflicto
                        const esConflicto = conflictos.some(c =>
                           c.dia === dia && c.hora === hora &&
                           ((c.sesion1.semestre == sesion.semestre && c.sesion1.materiaId === sesion.codigo) ||
                            (c.sesion2.semestre == sesion.semestre && c.sesion2.materiaId === sesion.codigo))
                        );

                        if (esConflicto) divClasses += ' conflict';
                        if (sesion.fijado) divClasses += ' fijado';

                        content = `
                            <div class="${divClasses}" data-dia="${dia}" data-hora="${hora}" data-materia="${sesion.codigo}" title="${sesion.materia} - ${sesion.profesor} - ${sesion.aula}">
                                <div class="font-medium truncate">${sesion.materia}</div>
                                <div class="truncate">${sesion.profesor}</div>
                                <div class="text-gray-600 truncate">${sesion.aula}</div>
                                ${tipoVista !== 'semestre' && sesion.semestre ? `<div class="text-gray-500">S${sesion.semestre}</div>` : ''}
                            </div>`;
                    } else {
                        cellClasses += " bg-gray-50"; // Fondo ligero para celdas vacías
                    }
                    html += `<td class="${cellClasses}">${content}</td>`;
                });
                html += '</tr>';
            });

            html += '</tbody>';
            tablaHorario.innerHTML = html;
            tablaHorario.classList.remove('hidden');
            container.classList.add('border', 'border-gray-200'); // Añadir borde al contenedor de la tabla
        }

        // Renderizar tabla de horario de asesorías para un profesor
        function renderizarHorarioAsesorias(profesorId) {
            // NOTA: Esta función es un placeholder. La asignación real de slots
            // para asesorías según la configuración no está implementada.
            // Solo muestra el horario del profesor marcando las clases.
            const tablaHorario = document.getElementById('tablaHorario');
            const tablaAsesorias = document.getElementById('tablaHorarioAsesorias');
            const mensajeNoHorario = document.getElementById('mensajeNoHorario');
            const container = document.getElementById('horarioContainer');

            tablaHorario.classList.add('hidden'); // Ocultar tabla regular
            mensajeNoHorario.classList.add('hidden'); // Ocultar mensaje

            const profesor = estado.profesores.find(p => p.id === profesorId);
            if (!profesor) {
                tablaAsesorias.classList.add('hidden');
                mensajeNoHorario.classList.remove('hidden');
                mensajeNoHorario.querySelector('h3').textContent = "Profesor no encontrado";
                mensajeNoHorario.querySelector('p').textContent = "";
                return;
            }

            const diasHabiles = obtenerDiasHabiles();
            const horasPorDia = calcularHorasPorDia();
            // const datosAsesorias = estado.horariosAsesorias[profesorId] || {}; // Datos reales de asesorías (no generados aún)
            const titulo = `Disponibilidad para Asesorías - ${profesor.nombre}`;

            let html = `<caption class="text-lg font-medium mb-2 caption-top text-gray-700 no-print">${titulo}</caption>`;
            html += '<thead><tr><th class="py-2 px-1 w-16">Hora</th>';
            diasHabiles.forEach(dia => { html += `<th class="py-2 px-1">${dia}</th>`; });
            html += '</tr></thead><tbody>';

            horasPorDia.forEach(hora => {
                html += `<tr><td class="py-1 px-1 font-medium bg-gray-50 text-xs">${hora}</td>`;
                diasHabiles.forEach(dia => {
                    // const asesoria = datosAsesorias[dia]?.[hora]; // Comprobar si hay asesoría asignada
                    let cellClasses = "p-1 h-16"; // Altura mínima
                    let content = '';

                    // Verificar si el profesor tiene clase regular en este slot
                    let tieneClase = false;
                    for (const sem in estado.horarios) {
                        if (estado.horarios[sem]?.[dia]?.[hora]?.profesorId === profesorId) {
                            tieneClase = true;
                            break;
                        }
                    }
                    // Verificar disponibilidad semanal
                    const turno = obtenerTurno(hora);
                    const disponibleSemanal = profesor.diasDisponibles?.[dia]?.[turno] ?? false;

                    if (tieneClase) {
                         cellClasses += " bg-gray-200"; // Marcar como ocupado por clase
                         content = `<div class="text-xs text-gray-400 italic">Clase</div>`;
                    } else if (!disponibleSemanal) {
                         cellClasses += " bg-red-100"; // Marcar como no disponible
                         content = `<div class="text-xs text-red-400 italic">No Disp.</div>`;
                    }
                    // else if (asesoria) { // Si tuviéramos asesorías asignadas
                    //     content = `<div class="bg-cyan-100 border-l-4 border-cyan-500 p-1 rounded text-xs" title="Asesoría">Asesoría</div>`;
                    // }
                    else {
                        cellClasses += " bg-green-50 hover:bg-green-100 cursor-pointer"; // Estilo para celdas vacías disponibles
                        // Añadir data attributes para posible asignación manual futura
                        content = `<div data-profesor-id="${profesorId}" data-dia="${dia}" data-hora="${hora}" class="h-full w-full"></div>`;
                    }
                    html += `<td class="${cellClasses}">${content}</td>`;
                });
                html += '</tr>';
            });
            html += '</tbody>';
            tablaAsesorias.innerHTML = html;
            tablaAsesorias.classList.remove('hidden');
            container.classList.add('border', 'border-gray-200');
        }

        // Actualizar estadísticas básicas del horario
        function actualizarEstadisticasHorario() {
            const horasAsignadasElem = document.getElementById('horasAsignadas');
            const aulasUtilizadasElem = document.getElementById('aulasUtilizadas');
            const conflictosDetectadosElem = document.getElementById('conflictosDetectados');
            if (!horasAsignadasElem || !aulasUtilizadasElem || !conflictosDetectadosElem) return;

            const stats = calcularEstadisticasDetalladas();

            horasAsignadasElem.textContent = `${stats.horasAsignadas}/${stats.horasNecesarias} (${stats.porcentajeHoras.toFixed(1)}%)`;

            const totalAulas = estado.aulas.length;
            const porcentajeAulas = totalAulas > 0 ? Math.round((stats.aulasUtilizadas.size / totalAulas) * 100) : 0;
            aulasUtilizadasElem.textContent = `${stats.aulasUtilizadas.size}/${totalAulas} (${porcentajeAulas}%)`;

            conflictosDetectadosElem.textContent = stats.conflictos.toString();
            conflictosDetectadosElem.className = `text-xl font-bold ${stats.conflictos > 0 ? 'text-red-600 animate-pulse' : 'text-green-600'}`; // Resaltar si hay conflictos

            // Opcional: Mostrar estadísticas avanzadas
            // mostrarEstadisticasAvanzadas();
        }

        // Actualizar interfaz general (selectores, etc.)
        function actualizarInterfaz() {
            // Configuración General
            document.getElementById('periodoAcademico').value = estado.configuracion.periodoAcademico;
            document.getElementById('cantidadSemestres').value = estado.configuracion.cantidadSemestres;
            document.getElementById('horaInicio').value = estado.configuracion.horaInicio;
            document.getElementById('horaFin').value = estado.configuracion.horaFin;
            document.getElementById('duracionBloque').value = estado.configuracion.duracionBloque;
            document.querySelectorAll('.dia-semana-check').forEach(chk => {
                chk.checked = estado.configuracion.diasDisponibles.includes(chk.dataset.dia);
            });

            // Configuración Asesorías
            const confAsesNormal = estado.configuracion.asesoriasNormalesConfig || {};
            document.getElementById('habilitarAsesoriasNormales').checked = confAsesNormal.habilitado || false;
            document.getElementById('duracionAsesoriaNormal').value = confAsesNormal.duracionMinutos || 60;
            document.getElementById('frecuenciaAsesoriaNormal').value = confAsesNormal.vecesPorSemana || 1;
            const confAsesEval = estado.configuracion.asesoriasEvaluacionConfig || {};
            document.getElementById('habilitarAsesoriasEvaluacion').checked = confAsesEval.habilitado || false;
            document.getElementById('duracionAsesoriaEvaluacion').value = confAsesEval.duracionMinutos || 120;
            document.getElementById('frecuenciaAsesoriaEvaluacion').value = confAsesEval.vecesPorSemana || 1;

            // Selectores dependientes
            actualizarSelectorTipoVista(); // Actualiza el selector de elementos y llama a actualizarHorarioVisible si es necesario
            actualizarSelectorSemestres(); // Actualiza selector en modal materia
            actualizarSelectoresHorariosFijos(); // Actualiza selectores en restricciones
        }

        // Actualizar estado de botones (Generar, Optimizar, Editar)
        function actualizarEstadoBotones() {
            const hayDatosBase = estado.profesores.length > 0 && estado.materias.length > 0 && estado.aulas.length > 0;
            const hayHorarios = estado.horarios && Object.keys(estado.horarios).length > 0;

            document.getElementById('generarHorariosBtn').disabled = !hayDatosBase;
            document.getElementById('generarHorariosBtnAlt').disabled = !hayDatosBase;
            document.getElementById('optimizarHorariosBtn').disabled = !hayHorarios;
            document.getElementById('modoEdicionBtn').disabled = !hayHorarios;

             // Actualizar texto de botones de generar
             const btnGen = document.getElementById('generarHorariosBtn');
             const btnGenAlt = document.getElementById('generarHorariosBtnAlt');
             if (!hayDatosBase) {
                 btnGen.textContent = "Faltan Datos";
                 btnGenAlt.textContent = "Faltan Datos";
             } else {
                 btnGen.textContent = "Generar Horarios";
                 btnGenAlt.textContent = "Generar Horarios";
             }
        }

        // Actualizar selector de vista de horario y el selector de elemento
        function actualizarSelectorTipoVista() {
            const filtroSelect = document.getElementById('filtroVistaHorario');
            const elementoSelect = document.getElementById('elementoSeleccionado');
            const label = elementoSelect.previousElementSibling; // El label antes del select
            const filtro = filtroSelect.value;
            const valorActual = elementoSelect.value; // Guardar valor actual para intentar restaurarlo

            elementoSelect.innerHTML = ''; // Limpiar opciones

            let opciones = [];
            switch (filtro) {
                case 'semestre':
                    label.textContent = 'Seleccione semestre:';
                    const cantSem = parseInt(estado.configuracion.cantidadSemestres) || 1;
                    for (let i = 1; i <= cantSem; i++) opciones.push({ value: i, text: `Semestre ${i}` });
                    if (opciones.length === 0) opciones.push({ value: '1', text: 'Semestre 1' }); // Default si no hay config
                    break;
                case 'profesor':
                    label.textContent = 'Seleccione profesor:';
                    opciones = estado.profesores.sort((a,b) => a.nombre.localeCompare(b.nombre)).map(p => ({ value: p.id, text: p.nombre }));
                    if (opciones.length === 0) opciones.push({ value: '', text: 'No hay profesores' });
                    break;
                case 'aula':
                    label.textContent = 'Seleccione aula:';
                    opciones = estado.aulas.sort((a,b) => a.nombre.localeCompare(b.nombre)).map(a => ({ value: a.id, text: a.nombre }));
                     if (opciones.length === 0) opciones.push({ value: '', text: 'No hay aulas' });
                    break;
                case 'materia':
                    label.textContent = 'Seleccione materia:';
                    // Usar código como value para materia en esta vista
                    opciones = estado.materias.sort((a,b) => a.nombre.localeCompare(b.nombre)).map(m => ({ value: m.codigo, text: `${m.nombre} (S${m.semestre})` }));
                     if (opciones.length === 0) opciones.push({ value: '', text: 'No hay materias' });
                    break;
                case 'asesoria':
                    label.textContent = 'Seleccione profesor:';
                    opciones = estado.profesores.sort((a,b) => a.nombre.localeCompare(b.nombre)).map(p => ({ value: p.id, text: p.nombre }));
                    if (opciones.length === 0) opciones.push({ value: '', text: 'No hay profesores' });
                    break;
            }

            opciones.forEach(opt => elementoSelect.add(new Option(opt.text, opt.value)));

            // Intentar restaurar el valor seleccionado si aún existe en las nuevas opciones
            if (opciones.some(opt => opt.value == valorActual)) {
                elementoSelect.value = valorActual;
            }

           // Siempre actualizar la vista al cambiar el tipo
           actualizarHorarioVisible();
        }

        // Actualizar AMBAS tablas de horario (regular y asesorías) según selección
        function actualizarHorarioVisible() {
            const filtro = document.getElementById('filtroVistaHorario').value;
            const elementoId = document.getElementById('elementoSeleccionado').value;
            renderizarHorario(filtro, elementoId);
            // La función renderizarHorario ahora llama a renderizarHorarioAsesorias si filtro es 'asesoria'
        }

        // Actualizar selector de semestres en modal Materia
        function actualizarSelectorSemestres() {
            const select = document.getElementById('materiaSemestre');
            if (!select) return;
            const currentVal = select.value; // Guardar valor actual si existe
            select.innerHTML = '';
            const cantSem = parseInt(estado.configuracion.cantidadSemestres) || 4;
            for (let i = 1; i <= cantSem; i++) {
                select.add(new Option(`Semestre ${i}`, i));
            }
            if (currentVal) select.value = currentVal; // Restaurar valor si es posible
        }

        // Actualizar selectores para fijar horarios
        function actualizarSelectoresHorariosFijos() {
            const profSelect = document.getElementById('profesorRestriccion');
            const matSelect = document.getElementById('materiaRestriccion');
            const aulaSelect = document.getElementById('aulaRestriccion');
            const diaSelect = document.getElementById('diaRestriccion');
            const horaSelect = document.getElementById('horaRestriccion');

            // Profesores
            if (profSelect) {
                const currentVal = profSelect.value;
                profSelect.innerHTML = '<option value="">Seleccione profesor</option>';
                estado.profesores.sort((a,b) => a.nombre.localeCompare(b.nombre)).forEach(p => profSelect.add(new Option(p.nombre, p.id)));
                if (currentVal) profSelect.value = currentVal;
            }
            // Materias (se llenan al cambiar profesor)
            if (matSelect) matSelect.innerHTML = '<option value="">Seleccione materia</option>';
            // Aulas (se llenan al cambiar materia)
            if (aulaSelect) aulaSelect.innerHTML = '<option value="">Seleccione aula</option>';

            // Días
            if (diaSelect) {
                 const currentVal = diaSelect.value;
                 diaSelect.innerHTML = '<option value="">Seleccione día</option>';
                 obtenerDiasHabiles().forEach(dia => diaSelect.add(new Option(dia, dia)));
                 if (currentVal) diaSelect.value = currentVal;
            }
            // Horas
            if (horaSelect) {
                 const currentVal = horaSelect.value;
                 horaSelect.innerHTML = '<option value="">Seleccione hora</option>';
                 calcularHorasPorDia().forEach(hora => horaSelect.add(new Option(hora, hora)));
                 if (currentVal) horaSelect.value = currentVal;
            }
        }

        // Cargar materias para el selector de restricciones (filtrando por profesor)
        function cargarMateriasParaRestriccion() {
            const profId = document.getElementById('profesorRestriccion').value;
            const matSelect = document.getElementById('materiaRestriccion');
            matSelect.innerHTML = '<option value="">Seleccione materia</option>';
            document.getElementById('aulaRestriccion').innerHTML = '<option value="">Seleccione aula</option>'; // Limpiar aulas

            const profesor = estado.profesores.find(p => p.id === profId);
            if (!profesor) {
                // Si no se selecciona profesor, no mostrar materias
                return;
            }

            // Filtrar materias que el profesor seleccionado puede dictar
            const materiasFiltradas = estado.materias.filter(m => profesor.materiasQueDicta?.includes(m.id));

            materiasFiltradas.sort((a,b)=> a.nombre.localeCompare(b.nombre)).forEach(m => {
                matSelect.add(new Option(`${m.nombre} (S${m.semestre})`, m.id));
            });
        }

        // Cargar aulas compatibles con la materia seleccionada en restricciones
        function cargarAulasParaRestriccion() {
            const matId = document.getElementById('materiaRestriccion').value;
            const aulaSelect = document.getElementById('aulaRestriccion');
            aulaSelect.innerHTML = '<option value="">Seleccione aula</option>';
            if (!matId) return;

            const materia = estado.materias.find(m => m.id === matId);
            if (!materia) return;
            const tipoReq = materia.tipoAula;

            estado.aulas
                .filter(a => a.tipo === tipoReq || (tipoReq === 'normal' && a.tipo === 'normal'))
                .sort((a,b) => a.nombre.localeCompare(b.nombre))
                .forEach(a => aulaSelect.add(new Option(`${a.nombre} (${a.tipo})`, a.id)));
        }

        // Filtrar tabla genérica
        function filtrarTabla(tablaId, inputId, columnaIdx) {
            try {
                const filtro = document.getElementById(inputId).value.toUpperCase();
                const tabla = document.getElementById(tablaId);
                const filas = tabla.querySelectorAll('tbody tr');
                filas.forEach(fila => {
                    const celda = fila.cells[columnaIdx];
                    if (celda) {
                        const texto = celda.textContent || celda.innerText;
                        fila.style.display = texto.toUpperCase().includes(filtro) ? '' : 'none';
                    }
                });
            } catch (e) { console.error("Error filtrando tabla:", e); }
        }

        // Filtrar aulas por tipo (llama a renderizarAulas)
        function filtrarAulasPorTipo() {
            renderizarAulas();
        }

        // Guardar configuración general y de asesorías
        function guardarConfiguracion() {
            // General
            estado.configuracion.periodoAcademico = document.getElementById('periodoAcademico').value;
            estado.configuracion.cantidadSemestres = parseInt(document.getElementById('cantidadSemestres').value) || 4;
            estado.configuracion.horaInicio = document.getElementById('horaInicio').value;
            estado.configuracion.horaFin = document.getElementById('horaFin').value;
            estado.configuracion.duracionBloque = parseInt(document.getElementById('duracionBloque').value) || 60;
            // Días
            estado.configuracion.diasDisponibles = [];
            document.querySelectorAll('.dia-semana-check:checked').forEach(chk => {
                estado.configuracion.diasDisponibles.push(chk.dataset.dia);
            });
            // Asesorías Normales
            estado.configuracion.asesoriasNormalesConfig = {
                habilitado: document.getElementById('habilitarAsesoriasNormales').checked,
                duracionMinutos: parseInt(document.getElementById('duracionAsesoriaNormal').value) || 60,
                vecesPorSemana: parseInt(document.getElementById('frecuenciaAsesoriaNormal').value) || 1
            };
            // Asesorías Evaluación
            estado.configuracion.asesoriasEvaluacionConfig = {
                habilitado: document.getElementById('habilitarAsesoriasEvaluacion').checked,
                duracionMinutos: parseInt(document.getElementById('duracionAsesoriaEvaluacion').value) || 120,
                vecesPorSemana: parseInt(document.getElementById('frecuenciaAsesoriaEvaluacion').value) || 1
            };

            guardarDatosLocalmente();
            actualizarInterfaz(); // Actualizar selectores y horas/días
            actualizarHorarioVisible(); // Forzar actualización de la vista del horario
            renderizarProfesores(); // Recalcular y mostrar carga detallada
            mostrarNotificacion('Éxito', 'Configuración guardada.', 'success');
        }


        // Mostrar/Ocultar opciones de PDF en el menú de exportación
        function togglePdfOptionsVisibility() {
            const formato = document.getElementById('formatoExportacion').value;
            const pdfOptionsDiv = document.getElementById('pdfOptions');
            if (formato === 'pdf') {
                pdfOptionsDiv.classList.remove('hidden');
            } else {
                pdfOptionsDiv.classList.add('hidden');
            }
        }


        // Cerrar un modal genérico
        function cerrarModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.add('hidden');
                modal.classList.remove('flex');
                estado.editandoId = null; // Limpiar ID en edición al cerrar cualquier modal
            }
        }

        // Mostrar informe de generación/optimización
        function mostrarInformeGeneracion(resultado) {
            const modal = document.getElementById('modalInforme');
            const titulo = document.getElementById('tituloInforme');
            const contenido = document.getElementById('contenidoInforme');
            titulo.textContent = "Informe de Generación de Horarios";

            let html = `<p class="mb-2">Estado: <span class="font-semibold ${resultado.estado === 'completo' ? 'text-green-600' : 'text-orange-600'}">${resultado.estado === 'completo' ? 'Completado' : 'Parcial'}</span></p>`;
            const stats = calcularEstadisticasDetalladas();
            html += `<p class="mb-2">Total de bloques semanales necesarios: ${stats.horasNecesarias}</p>`;
            html += `<p class="mb-2">Total de bloques asignados: ${stats.horasAsignadas} (${stats.porcentajeHoras.toFixed(1)}%)</p>`;
            html += `<p class="mb-2">Conflictos detectados (Profesor/Aula): ${stats.conflictos}</p>`;

            if (resultado.noAsignadas && resultado.noAsignadas.length > 0) {
                html += `<h4 class="font-semibold mt-4 mb-2 text-red-600">Materias con Bloques Faltantes:</h4>`;
                html += `<ul class="list-disc list-inside text-sm">`;
                resultado.noAsignadas.forEach(item => {
                    html += `<li>${item.materia}: Faltan ${item.faltantes} bloques</li>`;
                });
                html += `</ul>`;
            } else if (resultado.estado === 'completo') {
                 html += `<p class="mt-4 text-green-600 font-semibold">¡Todos los bloques requeridos fueron asignados!</p>`;
            }

            contenido.innerHTML = html;
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        function mostrarInformeOptimizacion(resultado) {
             const modal = document.getElementById('modalInforme');
            const titulo = document.getElementById('tituloInforme');
            const contenido = document.getElementById('contenidoInforme');
            titulo.textContent = "Informe de Optimización";

             let html = `<p class="mb-2">Conflictos resueltos: <span class="font-semibold">${resultado.conflictosResueltos || 0}</span></p>`;
             html += `<p class="mb-2">Huecos optimizados (heurística simple): <span class="font-semibold">${resultado.huecosOptimizados || 0}</span></p>`;
             html += `<p class="mb-2">Movimientos totales realizados: <span class="font-semibold">${resultado.movimientos || 0}</span></p>`;
             const stats = calcularEstadisticasDetalladas();
             html += `<p class="mt-4 mb-2">Conflictos restantes: ${stats.conflictos}</p>`;
             html += `<p class="mb-2">Bloques asignados: ${stats.horasAsignadas} (${stats.porcentajeHoras.toFixed(1)}%)</p>`;

             contenido.innerHTML = html;
             modal.classList.remove('hidden');
             modal.classList.add('flex');
        }

        // Calcular estadísticas detalladas
        function calcularEstadisticasDetalladas() {
             let horasNecesarias = 0;
             estado.materias.forEach(m => horasNecesarias += (m.horasSemana || 0)); // horasSemana son bloques
             let horasAsignadas = 0;
             const aulasUtilizadasSet = new Set();
             Object.values(estado.horarios).forEach(sem => {
                 Object.values(sem).forEach(dia => {
                     horasAsignadas += Object.keys(dia).length;
                     Object.values(dia).forEach(sesion => {
                         if (sesion.aulaId) aulasUtilizadasSet.add(sesion.aulaId);
                     });
                 });
             });
             const porcentajeHoras = horasNecesarias > 0 ? (horasAsignadas / horasNecesarias) * 100 : 0;
             const conflictos = detectarConflictos('profesor').length + detectarConflictos('aula').length;
             return { horasNecesarias, horasAsignadas, porcentajeHoras, conflictos, aulasUtilizadas: aulasUtilizadasSet };
        }

        // Calcular carga horaria DETALLADA por profesor
        function calcularCargaProfesoresDetallada() {
            const cargaDetallada = {};
            const semanasPorSemestre = 16; // Asunción, idealmente configurable
            const duracionBloqueHoras = (estado.configuracion.duracionBloque || 60) / 60;

            estado.profesores.forEach(prof => {
                let bloquesClase = 0;
                // Contar bloques de clase asignados
                for (const sem in estado.horarios) {
                    for (const dia in estado.horarios[sem]) {
                        for (const hora in estado.horarios[sem][dia]) {
                            if (estado.horarios[sem][dia][hora]?.profesorId === prof.id) {
                                bloquesClase++;
                            }
                        }
                    }
                }
                const horasClase = bloquesClase * duracionBloqueHoras; // Convertir bloques a horas

                const confAsesNormal = estado.configuracion.asesoriasNormalesConfig || {};
                const horasAsesNormal = confAsesNormal.habilitado
                    ? (confAsesNormal.duracionMinutos / 60) * confAsesNormal.vecesPorSemana
                    : 0;

                const confAsesEval = estado.configuracion.asesoriasEvaluacionConfig || {};
                const horasAsesEval = confAsesEval.habilitado
                    ? (confAsesEval.duracionMinutos / 60) * confAsesEval.vecesPorSemana
                    : 0;

                const horasInvestigacion = prof.horasInvestigacionSemanal || 0;
                const horasProyInst = prof.horasProyectosInstSemanal || 0;
                const horasProyExt = prof.horasProyectosExtSemanal || 0;
                const horasMaterial = prof.horasMaterialDidacticoSemanal || 0;
                const horasCapacitacion = (prof.horasCapacitacionSemestral || 0) / semanasPorSemestre;

                const totalHoras = horasClase + horasAsesNormal + horasAsesEval + horasInvestigacion +
                                 horasProyInst + horasProyExt + horasMaterial + horasCapacitacion;

                cargaDetallada[prof.id] = {
                    clases: horasClase.toFixed(1),
                    asesoriaNormal: horasAsesNormal.toFixed(1),
                    asesoriaEvaluacion: horasAsesEval.toFixed(1),
                    investigacion: horasInvestigacion.toFixed(1),
                    proyectosInst: horasProyInst.toFixed(1),
                    proyectosExt: horasProyExt.toFixed(1),
                    materialDidactico: horasMaterial.toFixed(1),
                    capacitacion: horasCapacitacion.toFixed(1),
                    total: totalHoras.toFixed(1),
                    // opcional: objetivo: prof.horasObjetivoSemanal || null
                };
            });
            return cargaDetallada;
        }


        // --- Funciones Auxiliares para Exportación y Visualización ---

        // Obtiene los datos y el título para una vista específica
        function obtenerDatosParaVista(tipoVista, elementoId) {
            let horario = {};
            let titulo = "Horario General"; // Default

            try {
                 switch (tipoVista) {
                    case 'semestre':
                        horario = estado.horariosVisualizacion.porSemestre[elementoId] || {};
                        titulo = `Semestre ${elementoId}`;
                        break;
                    case 'profesor':
                        const profesor = estado.profesores.find(p => p.id === elementoId);
                        horario = estado.horariosVisualizacion.porProfesor[elementoId] || {};
                        titulo = `Profesor ${profesor ? profesor.nombre : elementoId}`;
                        break;
                    case 'aula':
                        const aula = estado.aulas.find(a => a.id === elementoId);
                        horario = estado.horariosVisualizacion.porAula[elementoId] || {};
                        titulo = `Aula ${aula ? aula.nombre : elementoId}`;
                        break;
                    case 'materia': // Usa el código de materia como elementoId
                        const materia = estado.materias.find(m => m.codigo === elementoId); // Buscar por código
                        horario = estado.horariosVisualizacion.porMateria[elementoId] || {};
                        titulo = `Materia ${materia ? materia.nombre : elementoId}`;
                        break;
                    case 'asesoria': // Vista de asesoría no se exporta por este método
                         horario = {};
                         titulo = "Vista no exportable";
                         break;
                    default:
                         horario = {};
                         titulo = "Vista Desconocida";
                }
            } catch (e) { console.error("Error obteniendo datos para vista:", e); }

            return { horario, titulo };
        }


    </script>
</body>
</html>
